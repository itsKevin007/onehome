<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<title>OpenCV: How to run deep networks on Android device</title>
<link href="../../opencv.ico" rel="shortcut icon" type="image/x-icon" />
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../tutorial-utils.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  },
  loader: {
    load: ['[tex]/ams']
  },
  tex: {
    macros: {},
    packages: ['base','configmacros','ams']
  }
};
//<![CDATA[
window.MathJax = {
    loader: {load: ['[tex]/ams']},
    tex: {
        packages: {'[+]': ['ams']},
        macros: {
            matTT: [ "\\[ \\left|\\begin{array}{ccc} #1 & #2 & #3\\\\ #4 & #5 & #6\\\\ #7 & #8 & #9 \\end{array}\\right| \\]", 9],
            fork: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ \\end{array} \\right.", 4],
            forkthree: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ #5 & \\mbox{#6}\\\\ \\end{array} \\right.", 6],
            forkfour: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ #5 & \\mbox{#6}\\\\ #7 & \\mbox{#8}\\\\ \\end{array} \\right.", 8],
            vecthree: ["\\begin{bmatrix} #1\\\\ #2\\\\ #3 \\end{bmatrix}", 3],
            vecthreethree: ["\\begin{bmatrix} #1 & #2 & #3\\\\ #4 & #5 & #6\\\\ #7 & #8 & #9 \\end{bmatrix}", 9],
            cameramatrix: ["#1 = \\begin{bmatrix} f_x & 0 & c_x\\\\ 0 & f_y & c_y\\\\ 0 & 0 & 1 \\end{bmatrix}", 1],
            distcoeffs: ["(k_1, k_2, p_1, p_2[, k_3[, k_4, k_5, k_6 [, s_1, s_2, s_3, s_4[, \\tau_x, \\tau_y]]]]) \\text{ of 4, 5, 8, 12 or 14 elements}"],
            distcoeffsfisheye: ["(k_1, k_2, k_3, k_4)"],
            hdotsfor: ["\\dots", 1],
            mathbbm: ["\\mathbb{#1}", 1],
            bordermatrix: ["\\matrix{#1}", 1]
        },
        processEscapes: false
    }
};
//]]>
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-chtml.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<!--#include virtual="/google-search.html"-->
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../opencv-logo-small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">OpenCV
   &#160;<span id="projectnumber">4.10.0</span>
   </div>
   <div id="projectbrief">Open Source Computer Vision</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../d9/df8/tutorial_root.html">OpenCV Tutorials</a></li><li class="navelem"><a class="el" href="../../df/d65/tutorial_table_of_content_introduction.html">Introduction to OpenCV</a></li>  </ul>
</div>
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">How to run deep networks on Android device</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md840">Introduction</a></li>
<li class="level1"><a href="#autotoc_md841">Requirements</a></li>
<li class="level1"><a href="#autotoc_md842">Create an empty Android Studio project and add OpenCV dependency</a></li>
<li class="level1"><a href="#autotoc_md843">Make an app</a></li>
</ul>
</div>
<div class="textblock"><p><b>Prev Tutorial:</b> <a class="el" href="../../d5/df8/tutorial_dev_with_OCV_on_Android.html">Android Development with OpenCV</a> <br  />
<b>Next Tutorial:</b> <a class="el" href="../../d7/dbd/tutorial_android_ocl_intro.html">Use OpenCL in Android camera preview based CV application</a> <br  />
 </p><dl class="section see"><dt>See also</dt><dd><a class="el" href="../../d2/d58/tutorial_table_of_content_dnn.html">Deep Neural Networks (dnn module)</a></dd></dl>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadRight"></th><th class="markdownTableHeadLeft"></th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyRight">Original author   </td><td class="markdownTableBodyLeft">Dmitry Kurtaev    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyRight">Compatibility   </td><td class="markdownTableBodyLeft">OpenCV &gt;= 4.9   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md840"></a>
Introduction</h1>
<p>In this tutorial you'll know how to run deep learning networks on Android device using OpenCV deep learning module. Tutorial was written for Android Studio 2022.2.1.</p>
<h1><a class="anchor" id="autotoc_md841"></a>
Requirements</h1>
<ul>
<li>Download and install Android Studio from <a href="https://developer.android.com/studio">https://developer.android.com/studio</a>.</li>
<li>Get the latest pre-built OpenCV for Android release from <a href="https://github.com/opencv/opencv/releases">https://github.com/opencv/opencv/releases</a> and unpack it (for example, <code>opencv-4.X.Y-android-sdk.zip</code>, minimum version 4.9 is required).</li>
<li>Download MobileNet object detection model from <a href="https://github.com/chuanqi305/MobileNet-SSD">https://github.com/chuanqi305/MobileNet-SSD</a>. Configuration file <code>MobileNetSSD_deploy.prototxt</code> and model weights <code>MobileNetSSD_deploy.caffemodel</code> are required.</li>
</ul>
<h1><a class="anchor" id="autotoc_md842"></a>
Create an empty Android Studio project and add OpenCV dependency</h1>
<p>Use <a class="el" href="../../d5/df8/tutorial_dev_with_OCV_on_Android.html">Android Development with OpenCV</a> tutorial to initialize your project and add OpenCV.</p>
<h1><a class="anchor" id="autotoc_md843"></a>
Make an app</h1>
<p>Our sample will takes pictures from a camera, forwards it into a deep network and receives a set of rectangles, class identifiers and confidence values in range [0, 1].</p>
<ul>
<li>First of all, we need to add a necessary widget which displays processed frames. Modify <code>app/src/main/res/layout/activity_main.xml</code>: <div class="fragment"><div class="line">&lt;?<span class="keyword">xml</span> <span class="keyword">version</span>=<span class="stringliteral">&quot;1.0&quot;</span> <span class="keyword">encoding</span>=<span class="stringliteral">&quot;utf-8&quot;</span>?&gt;</div>
<div class="line">&lt;<span class="keywordtype">FrameLayout</span> <span class="keyword">xmlns:android</span>=<span class="stringliteral">&quot;http://schemas.android.com/apk/res/android&quot;</span></div>
<div class="line">    <span class="keyword">xmlns:app</span>=<span class="stringliteral">&quot;http://schemas.android.com/apk/res-auto&quot;</span></div>
<div class="line">    <span class="keyword">xmlns:tools</span>=<span class="stringliteral">&quot;http://schemas.android.com/tools&quot;</span></div>
<div class="line">    <span class="keyword">android:layout_width</span>=<span class="stringliteral">&quot;match_parent&quot;</span></div>
<div class="line">    <span class="keyword">android:layout_height</span>=<span class="stringliteral">&quot;match_parent&quot;</span></div>
<div class="line">    <span class="keyword">tools:context</span>=<span class="stringliteral">&quot;org.opencv.samples.opencv_mobilenet.MainActivity&quot;</span>&gt;</div>
<div class="line"> </div>
<div class="line">    &lt;<span class="keywordtype">org.opencv.android.JavaCameraView</span></div>
<div class="line">        <span class="keyword">android:id</span>=<span class="stringliteral">&quot;@+id/CameraView&quot;</span></div>
<div class="line">        <span class="keyword">android:layout_width</span>=<span class="stringliteral">&quot;match_parent&quot;</span></div>
<div class="line">        <span class="keyword">android:layout_height</span>=<span class="stringliteral">&quot;match_parent&quot;</span></div>
<div class="line">        <span class="keyword">android:visibility</span>=<span class="stringliteral">&quot;visible&quot;</span> /&gt;</div>
<div class="line">&lt;/<span class="keywordtype">FrameLayout</span>&gt;</div>
</div><!-- fragment --></li>
<li>Modify <code>/app/src/main/AndroidManifest.xml</code> to enable full-screen mode, set up a correct screen orientation and allow to use a camera. <div class="fragment"><div class="line">&lt;?<span class="keyword">xml</span> <span class="keyword">version</span>=<span class="stringliteral">&quot;1.0&quot;</span> <span class="keyword">encoding</span>=<span class="stringliteral">&quot;utf-8&quot;</span>?&gt;</div>
<div class="line">&lt;<span class="keywordtype">manifest</span> <span class="keyword">xmlns:android</span>=<span class="stringliteral">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</div>
<div class="line"> </div>
<div class="line">    &lt;<span class="keywordtype">application</span></div>
<div class="line">        <span class="keyword">android:label</span>=<span class="stringliteral">&quot;@string/app_name&quot;</span>&gt;</div>
</div><!-- fragment --> <div class="fragment"><div class="line">        &lt;<span class="keywordtype">activity</span></div>
<div class="line">                  <span class="keyword">android:exported</span>=<span class="stringliteral">&quot;true&quot;</span></div>
<div class="line">                  <span class="keyword">android:name</span>=<span class="stringliteral">&quot;.MainActivity&quot;</span></div>
<div class="line">                  <span class="keyword">android:screenOrientation</span>=<span class="stringliteral">&quot;landscape&quot;</span>&gt;  <span class="comment">&lt;!--Screen orientation--&gt;</span></div>
<div class="line">            &lt;<span class="keywordtype">intent-filter</span>&gt;</div>
<div class="line">                &lt;<span class="keywordtype">action</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.intent.action.MAIN&quot;</span> /&gt;</div>
<div class="line">                &lt;<span class="keywordtype">category</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</div>
<div class="line">            &lt;/<span class="keywordtype">intent-filter</span>&gt;</div>
<div class="line">        &lt;/<span class="keywordtype">activity</span>&gt;</div>
<div class="line">    &lt;/<span class="keywordtype">application</span>&gt;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">&lt;!--Allow to use a camera--&gt;</span></div>
<div class="line">    &lt;<span class="keywordtype">uses-permission</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.permission.CAMERA&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">uses-feature</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.hardware.camera&quot;</span> <span class="keyword">android:required</span>=<span class="stringliteral">&quot;false&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">uses-feature</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.hardware.camera.autofocus&quot;</span> <span class="keyword">android:required</span>=<span class="stringliteral">&quot;false&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">uses-feature</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.hardware.camera.front&quot;</span> <span class="keyword">android:required</span>=<span class="stringliteral">&quot;false&quot;</span>/&gt;</div>
<div class="line">    &lt;<span class="keywordtype">uses-feature</span> <span class="keyword">android:name</span>=<span class="stringliteral">&quot;android.hardware.camera.front.autofocus&quot;</span> <span class="keyword">android:required</span>=<span class="stringliteral">&quot;false&quot;</span>/&gt;</div>
<div class="line"> </div>
<div class="line">&lt;/<span class="keywordtype">manifest</span>&gt;</div>
</div><!-- fragment --></li>
<li>Replace content of <code>app/src/main/java/com/example/myapplication/MainActivity.java</code> and set a custom package name if necessary:</li>
</ul>
<div class="fragment"><div class="line"><span class="keyword">package </span>com.example.myapplication;</div>
</div><!-- fragment --> <div class="fragment"><div class="line"><span class="keyword">import</span> android.content.Context;</div>
<div class="line"><span class="keyword">import</span> android.content.res.AssetManager;</div>
<div class="line"><span class="keyword">import</span> android.os.Bundle;</div>
<div class="line"><span class="keyword">import</span> android.util.Log;</div>
<div class="line"><span class="keyword">import</span> android.widget.Toast;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">import</span> org.opencv.android.CameraActivity;</div>
<div class="line"><span class="keyword">import</span> org.opencv.android.CameraBridgeViewBase;</div>
<div class="line"><span class="keyword">import</span> org.opencv.android.CameraBridgeViewBase.CvCameraViewFrame;</div>
<div class="line"><span class="keyword">import</span> org.opencv.android.CameraBridgeViewBase.CvCameraViewListener2;</div>
<div class="line"><span class="keyword">import</span> org.opencv.android.OpenCVLoader;</div>
<div class="line"><span class="keyword">import</span> org.opencv.core.Core;</div>
<div class="line"><span class="keyword">import</span> org.opencv.core.Mat;</div>
<div class="line"><span class="keyword">import</span> org.opencv.core.MatOfByte;</div>
<div class="line"><span class="keyword">import</span> org.opencv.core.Point;</div>
<div class="line"><span class="keyword">import</span> org.opencv.core.Scalar;</div>
<div class="line"><span class="keyword">import</span> org.opencv.core.Size;</div>
<div class="line"><span class="keyword">import</span> org.opencv.dnn.Net;</div>
<div class="line"><span class="keyword">import</span> org.opencv.dnn.Dnn;</div>
<div class="line"><span class="keyword">import</span> org.opencv.imgproc.Imgproc;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">import</span> java.io.InputStream;</div>
<div class="line"><span class="keyword">import</span> java.io.IOException;</div>
<div class="line"><span class="keyword">import</span> java.util.Collections;</div>
<div class="line"><span class="keyword">import</span> java.util.List;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span> <span class="keyword">class </span>MainActivity <span class="keyword">extends</span> CameraActivity implements CvCameraViewListener2 {</div>
<div class="line"> </div>
<div class="line">    @Override</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> onResume() {</div>
<div class="line">        super.onResume();</div>
<div class="line">        <span class="keywordflow">if</span> (mOpenCvCameraView != <span class="keyword">null</span>)</div>
<div class="line">            mOpenCvCameraView.enableView();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    @Override</div>
<div class="line">    <span class="keyword">protected</span> <span class="keywordtype">void</span> onCreate(Bundle savedInstanceState) {</div>
<div class="line">        super.onCreate(savedInstanceState);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (OpenCVLoader.initLocal()) {</div>
<div class="line">            Log.i(TAG, <span class="stringliteral">&quot;OpenCV loaded successfully&quot;</span>);</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            Log.e(TAG, <span class="stringliteral">&quot;OpenCV initialization failed!&quot;</span>);</div>
<div class="line">            (Toast.makeText(<span class="keyword">this</span>, <span class="stringliteral">&quot;OpenCV initialization failed!&quot;</span>, Toast.LENGTH_LONG)).show();</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        mModelBuffer = loadFileFromResource(R.raw.mobilenet_iter_73000);</div>
<div class="line">        mConfigBuffer = loadFileFromResource(R.raw.deploy);</div>
<div class="line">        <span class="keywordflow">if</span> (mModelBuffer == <span class="keyword">null</span> || mConfigBuffer == <span class="keyword">null</span>) {</div>
<div class="line">            Log.e(TAG, <span class="stringliteral">&quot;Failed to load model from resources&quot;</span>);</div>
<div class="line">        } <span class="keywordflow">else</span></div>
<div class="line">            Log.i(TAG, <span class="stringliteral">&quot;Model files loaded successfully&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        net = Dnn.readNet(<span class="stringliteral">&quot;caffe&quot;</span>, mModelBuffer, mConfigBuffer);</div>
<div class="line">        Log.i(TAG, <span class="stringliteral">&quot;Network loaded successfully&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        setContentView(R.layout.activity_main);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Set up camera listener.</span></div>
<div class="line">        mOpenCvCameraView = (CameraBridgeViewBase)findViewById(R.id.CameraView);</div>
<div class="line">        mOpenCvCameraView.setVisibility(CameraBridgeViewBase.VISIBLE);</div>
<div class="line">        mOpenCvCameraView.setCvCameraViewListener(<span class="keyword">this</span>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    @Override</div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> onPause()</div>
<div class="line">    {</div>
<div class="line">        super.onPause();</div>
<div class="line">        <span class="keywordflow">if</span> (mOpenCvCameraView != <span class="keyword">null</span>)</div>
<div class="line">            mOpenCvCameraView.disableView();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    @Override</div>
<div class="line">    <span class="keyword">protected</span> List&lt;? extends CameraBridgeViewBase&gt; getCameraViewList() {</div>
<div class="line">        <span class="keywordflow">return</span> Collections.singletonList(mOpenCvCameraView);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> onDestroy() {</div>
<div class="line">        super.onDestroy();</div>
<div class="line">        <span class="keywordflow">if</span> (mOpenCvCameraView != <span class="keyword">null</span>)</div>
<div class="line">            mOpenCvCameraView.disableView();</div>
<div class="line"> </div>
<div class="line">        mModelBuffer.release();</div>
<div class="line">        mConfigBuffer.release();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Load a network.</span></div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> onCameraViewStarted(<span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height) {</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">public</span> Mat onCameraFrame(CvCameraViewFrame inputFrame) {</div>
<div class="line">        <span class="keyword">final</span> <span class="keywordtype">int</span> IN_WIDTH = 300;</div>
<div class="line">        <span class="keyword">final</span> <span class="keywordtype">int</span> IN_HEIGHT = 300;</div>
<div class="line">        <span class="keyword">final</span> <span class="keywordtype">float</span> WH_RATIO = (float)IN_WIDTH / IN_HEIGHT;</div>
<div class="line">        <span class="keyword">final</span> <span class="keywordtype">double</span> IN_SCALE_FACTOR = 0.007843;</div>
<div class="line">        <span class="keyword">final</span> <span class="keywordtype">double</span> MEAN_VAL = 127.5;</div>
<div class="line">        <span class="keyword">final</span> <span class="keywordtype">double</span> THRESHOLD = 0.2;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Get a new frame</span></div>
<div class="line">        Log.d(TAG, <span class="stringliteral">&quot;handle new frame!&quot;</span>);</div>
<div class="line">        Mat frame = inputFrame.rgba();</div>
<div class="line">        Imgproc.cvtColor(frame, frame, Imgproc.COLOR_RGBA2RGB);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Forward image through network.</span></div>
<div class="line">        Mat blob = Dnn.blobFromImage(frame, IN_SCALE_FACTOR,</div>
<div class="line">                <span class="keyword">new</span> <a class="code hl_typedef" href="../../dc/d84/group__core__basic.html#ga346f563897249351a34549137c8532a0">Size</a>(IN_WIDTH, IN_HEIGHT),</div>
<div class="line">                <span class="keyword">new</span> <a class="code hl_typedef" href="../../dc/d84/group__core__basic.html#ga599fe92e910c027be274233eccad7beb">Scalar</a>(MEAN_VAL, MEAN_VAL, MEAN_VAL), <span class="comment">/*swapRB*/</span><span class="keyword">false</span>, <span class="comment">/*crop*/</span><span class="keyword">false</span>);</div>
<div class="line">        net.setInput(blob);</div>
<div class="line">        Mat detections = net.forward();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">int</span> cols = frame.cols();</div>
<div class="line">        <span class="keywordtype">int</span> rows = frame.rows();</div>
<div class="line"> </div>
<div class="line">        detections = detections.reshape(1, (<span class="keywordtype">int</span>)detections.total() / 7);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; detections.rows(); ++i) {</div>
<div class="line">            <span class="keywordtype">double</span> confidence = detections.get(i, 2)[0];</div>
<div class="line">            <span class="keywordflow">if</span> (confidence &gt; THRESHOLD) {</div>
<div class="line">                <span class="keywordtype">int</span> classId = (int)detections.get(i, 1)[0];</div>
<div class="line"> </div>
<div class="line">                <span class="keywordtype">int</span> left   = (int)(detections.get(i, 3)[0] * cols);</div>
<div class="line">                <span class="keywordtype">int</span> top    = (int)(detections.get(i, 4)[0] * rows);</div>
<div class="line">                <span class="keywordtype">int</span> right  = (int)(detections.get(i, 5)[0] * cols);</div>
<div class="line">                <span class="keywordtype">int</span> bottom = (int)(detections.get(i, 6)[0] * rows);</div>
<div class="line"> </div>
<div class="line">                <span class="comment">// Draw rectangle around detected object.</span></div>
<div class="line">                Imgproc.rectangle(frame, <span class="keyword">new</span> <a class="code hl_typedef" href="../../dc/d84/group__core__basic.html#ga1e83eafb2d26b3c93f09e8338bcab192">Point</a>(left, top), <span class="keyword">new</span> <a class="code hl_typedef" href="../../dc/d84/group__core__basic.html#ga1e83eafb2d26b3c93f09e8338bcab192">Point</a>(right, bottom),</div>
<div class="line">                                  <span class="keyword">new</span> <a class="code hl_typedef" href="../../dc/d84/group__core__basic.html#ga599fe92e910c027be274233eccad7beb">Scalar</a>(0, 255, 0));</div>
<div class="line">                <a class="code hl_typedef" href="../../dc/d84/group__core__basic.html#ga1f6634802eeadfd7245bc75cf3e216c2">String</a> label = classNames[classId] + <span class="stringliteral">&quot;: &quot;</span> + confidence;</div>
<div class="line">                <span class="keywordtype">int</span>[] baseLine = <span class="keyword">new</span> <span class="keywordtype">int</span>[1];</div>
<div class="line">                <a class="code hl_typedef" href="../../dc/d84/group__core__basic.html#ga346f563897249351a34549137c8532a0">Size</a> labelSize = Imgproc.getTextSize(label, Imgproc.FONT_HERSHEY_SIMPLEX, 0.5, 1, baseLine);</div>
<div class="line"> </div>
<div class="line">                <span class="comment">// Draw background for label.</span></div>
<div class="line">                Imgproc.rectangle(frame, <span class="keyword">new</span> <a class="code hl_typedef" href="../../dc/d84/group__core__basic.html#ga1e83eafb2d26b3c93f09e8338bcab192">Point</a>(left, top - labelSize.height),</div>
<div class="line">                                  <span class="keyword">new</span> <a class="code hl_typedef" href="../../dc/d84/group__core__basic.html#ga1e83eafb2d26b3c93f09e8338bcab192">Point</a>(left + labelSize.width, top + baseLine[0]),</div>
<div class="line">                                  <span class="keyword">new</span> <a class="code hl_typedef" href="../../dc/d84/group__core__basic.html#ga599fe92e910c027be274233eccad7beb">Scalar</a>(255, 255, 255), Imgproc.FILLED);</div>
<div class="line">                <span class="comment">// Write class name and confidence.</span></div>
<div class="line">                Imgproc.putText(frame, label, <span class="keyword">new</span> <a class="code hl_typedef" href="../../dc/d84/group__core__basic.html#ga1e83eafb2d26b3c93f09e8338bcab192">Point</a>(left, top),</div>
<div class="line">                        Imgproc.FONT_HERSHEY_SIMPLEX, 0.5, <span class="keyword">new</span> <a class="code hl_typedef" href="../../dc/d84/group__core__basic.html#ga599fe92e910c027be274233eccad7beb">Scalar</a>(0, 0, 0));</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> frame;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> onCameraViewStopped() {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">private</span> MatOfByte loadFileFromResource(<span class="keywordtype">int</span> <span class="keywordtype">id</span>) {</div>
<div class="line">       <span class="keywordtype">byte</span>[] buffer;</div>
<div class="line">        <span class="keywordflow">try</span> {</div>
<div class="line">            <span class="comment">// load cascade file from application resources</span></div>
<div class="line">            InputStream is = getResources().openRawResource(<span class="keywordtype">id</span>);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordtype">int</span> <a class="code hl_function" href="../../df/d5b/namespacecv_1_1gapi_1_1streaming.html#abc5db6c129a4ea2177b3bfce576d9499">size</a> = is.available();</div>
<div class="line">            buffer = <span class="keyword">new</span> <span class="keywordtype">byte</span>[<a class="code hl_function" href="../../df/d5b/namespacecv_1_1gapi_1_1streaming.html#abc5db6c129a4ea2177b3bfce576d9499">size</a>];</div>
<div class="line">            <span class="keywordtype">int</span> bytesRead = is.read(buffer);</div>
<div class="line">            is.close();</div>
<div class="line">        } <span class="keywordflow">catch</span> (IOException e) {</div>
<div class="line">            e.printStackTrace();</div>
<div class="line">            Log.e(TAG, <span class="stringliteral">&quot;Failed to ONNX model from resources! Exception thrown: &quot;</span> + e);</div>
<div class="line">            (Toast.makeText(<span class="keyword">this</span>, <span class="stringliteral">&quot;Failed to ONNX model from resources!&quot;</span>, Toast.LENGTH_LONG)).show();</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">null</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">new</span> MatOfByte(buffer);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <a class="code hl_typedef" href="../../dc/d84/group__core__basic.html#ga1f6634802eeadfd7245bc75cf3e216c2">String</a> TAG = <span class="stringliteral">&quot;OpenCV-MobileNet&quot;</span>;</div>
<div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <a class="code hl_typedef" href="../../dc/d84/group__core__basic.html#ga1f6634802eeadfd7245bc75cf3e216c2">String</a>[] classNames = {<span class="stringliteral">&quot;background&quot;</span>,</div>
<div class="line">            <span class="stringliteral">&quot;aeroplane&quot;</span>, <span class="stringliteral">&quot;bicycle&quot;</span>, <span class="stringliteral">&quot;bird&quot;</span>, <span class="stringliteral">&quot;boat&quot;</span>,</div>
<div class="line">            <span class="stringliteral">&quot;bottle&quot;</span>, <span class="stringliteral">&quot;bus&quot;</span>, <span class="stringliteral">&quot;car&quot;</span>, <span class="stringliteral">&quot;cat&quot;</span>, <span class="stringliteral">&quot;chair&quot;</span>,</div>
<div class="line">            <span class="stringliteral">&quot;cow&quot;</span>, <span class="stringliteral">&quot;diningtable&quot;</span>, <span class="stringliteral">&quot;dog&quot;</span>, <span class="stringliteral">&quot;horse&quot;</span>,</div>
<div class="line">            <span class="stringliteral">&quot;motorbike&quot;</span>, <span class="stringliteral">&quot;person&quot;</span>, <span class="stringliteral">&quot;pottedplant&quot;</span>,</div>
<div class="line">            <span class="stringliteral">&quot;sheep&quot;</span>, <span class="stringliteral">&quot;sofa&quot;</span>, <span class="stringliteral">&quot;train&quot;</span>, <span class="stringliteral">&quot;tvmonitor&quot;</span>};</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">private</span> MatOfByte            mConfigBuffer;</div>
<div class="line">    <span class="keyword">private</span> MatOfByte            mModelBuffer;</div>
<div class="line">    <span class="keyword">private</span> Net                  net;</div>
<div class="line">    <span class="keyword">private</span> CameraBridgeViewBase mOpenCvCameraView;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__core__basic_html_ga1e83eafb2d26b3c93f09e8338bcab192"><div class="ttname"><a href="../../dc/d84/group__core__basic.html#ga1e83eafb2d26b3c93f09e8338bcab192">cv::Point</a></div><div class="ttdeci">Point2i Point</div><div class="ttdef"><b>Definition</b> types.hpp:209</div></div>
<div class="ttc" id="agroup__core__basic_html_ga1f6634802eeadfd7245bc75cf3e216c2"><div class="ttname"><a href="../../dc/d84/group__core__basic.html#ga1f6634802eeadfd7245bc75cf3e216c2">cv::String</a></div><div class="ttdeci">std::string String</div><div class="ttdef"><b>Definition</b> cvstd.hpp:151</div></div>
<div class="ttc" id="agroup__core__basic_html_ga346f563897249351a34549137c8532a0"><div class="ttname"><a href="../../dc/d84/group__core__basic.html#ga346f563897249351a34549137c8532a0">cv::Size</a></div><div class="ttdeci">Size2i Size</div><div class="ttdef"><b>Definition</b> types.hpp:370</div></div>
<div class="ttc" id="agroup__core__basic_html_ga599fe92e910c027be274233eccad7beb"><div class="ttname"><a href="../../dc/d84/group__core__basic.html#ga599fe92e910c027be274233eccad7beb">cv::Scalar</a></div><div class="ttdeci">Scalar_&lt; double &gt; Scalar</div><div class="ttdef"><b>Definition</b> types.hpp:702</div></div>
<div class="ttc" id="anamespacecv_1_1gapi_1_1streaming_html_abc5db6c129a4ea2177b3bfce576d9499"><div class="ttname"><a href="../../df/d5b/namespacecv_1_1gapi_1_1streaming.html#abc5db6c129a4ea2177b3bfce576d9499">cv::gapi::streaming::size</a></div><div class="ttdeci">GOpaque&lt; Size &gt; size(const GMat &amp;src)</div><div class="ttdoc">Gets dimensions from Mat.</div></div>
</div><!-- fragment --><ul>
<li>Put downloaded <code>deploy.prototxt</code> and <code>mobilenet_iter_73000.caffemodel</code> into <code>app/src/main/res/raw</code> folder. OpenCV DNN model is mainly designed to load ML and DNN models from file. Modern Android does not allow it without extra permissions, but provides Java API to load bytes from resources. The sample uses alternative DNN API that initializes a model from in-memory buffer rather than a file. The following function reads model file from resources and converts it to <code>MatOfBytes</code> (analog of <code>std::vector&lt;char&gt;</code> in C++ world) object suitable for OpenCV Java API:</li>
</ul>
<div class="fragment"><div class="line">    <span class="keyword">private</span> MatOfByte loadFileFromResource(<span class="keywordtype">int</span> <span class="keywordtype">id</span>) {</div>
<div class="line">       <span class="keywordtype">byte</span>[] buffer;</div>
<div class="line">        <span class="keywordflow">try</span> {</div>
<div class="line">            <span class="comment">// load cascade file from application resources</span></div>
<div class="line">            InputStream is = getResources().openRawResource(<span class="keywordtype">id</span>);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordtype">int</span> size = is.available();</div>
<div class="line">            buffer = <span class="keyword">new</span> <span class="keywordtype">byte</span>[size];</div>
<div class="line">            <span class="keywordtype">int</span> bytesRead = is.read(buffer);</div>
<div class="line">            is.close();</div>
<div class="line">        } <span class="keywordflow">catch</span> (IOException e) {</div>
<div class="line">            e.printStackTrace();</div>
<div class="line">            Log.e(TAG, <span class="stringliteral">&quot;Failed to ONNX model from resources! Exception thrown: &quot;</span> + e);</div>
<div class="line">            (Toast.makeText(<span class="keyword">this</span>, <span class="stringliteral">&quot;Failed to ONNX model from resources!&quot;</span>, Toast.LENGTH_LONG)).show();</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">null</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">new</span> MatOfByte(buffer);</div>
<div class="line">    }</div>
</div><!-- fragment --><p>And then the network initialization is done with the following lines:</p>
<div class="fragment"><div class="line">        mModelBuffer = loadFileFromResource(R.raw.mobilenet_iter_73000);</div>
<div class="line">        mConfigBuffer = loadFileFromResource(R.raw.deploy);</div>
<div class="line">        <span class="keywordflow">if</span> (mModelBuffer == <span class="keyword">null</span> || mConfigBuffer == <span class="keyword">null</span>) {</div>
<div class="line">            Log.e(TAG, <span class="stringliteral">&quot;Failed to load model from resources&quot;</span>);</div>
<div class="line">        } <span class="keywordflow">else</span></div>
<div class="line">            Log.i(TAG, <span class="stringliteral">&quot;Model files loaded successfully&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        net = Dnn.readNet(<span class="stringliteral">&quot;caffe&quot;</span>, mModelBuffer, mConfigBuffer);</div>
<div class="line">        Log.i(TAG, <span class="stringliteral">&quot;Network loaded successfully&quot;</span>);</div>
</div><!-- fragment --><p>See also <a href="https://developer.android.com/guide/topics/resources/providing-resources.html" target="_blank">Android documentation on resources</a></p>
<ul>
<li>Take a look how DNN model input is prepared and inference result is interpreted:</li>
</ul>
<div class="fragment"><div class="line">        Mat blob = Dnn.blobFromImage(frame, IN_SCALE_FACTOR,</div>
<div class="line">                <span class="keyword">new</span> Size(IN_WIDTH, IN_HEIGHT),</div>
<div class="line">                <span class="keyword">new</span> Scalar(MEAN_VAL, MEAN_VAL, MEAN_VAL), <span class="comment">/*swapRB*/</span><span class="keyword">false</span>, <span class="comment">/*crop*/</span><span class="keyword">false</span>);</div>
<div class="line">        net.setInput(blob);</div>
<div class="line">        Mat detections = net.forward();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">int</span> cols = frame.cols();</div>
<div class="line">        <span class="keywordtype">int</span> rows = frame.rows();</div>
<div class="line"> </div>
<div class="line">        detections = detections.reshape(1, (<span class="keywordtype">int</span>)detections.total() / 7);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; detections.rows(); ++i) {</div>
<div class="line">            <span class="keywordtype">double</span> confidence = detections.get(i, 2)[0];</div>
<div class="line">            <span class="keywordflow">if</span> (confidence &gt; THRESHOLD) {</div>
<div class="line">                <span class="keywordtype">int</span> classId = (int)detections.get(i, 1)[0];</div>
<div class="line"> </div>
<div class="line">                <span class="keywordtype">int</span> left   = (int)(detections.get(i, 3)[0] * cols);</div>
<div class="line">                <span class="keywordtype">int</span> top    = (int)(detections.get(i, 4)[0] * rows);</div>
<div class="line">                <span class="keywordtype">int</span> right  = (int)(detections.get(i, 5)[0] * cols);</div>
<div class="line">                <span class="keywordtype">int</span> bottom = (int)(detections.get(i, 6)[0] * rows);</div>
<div class="line"> </div>
<div class="line">                <span class="comment">// Draw rectangle around detected object.</span></div>
<div class="line">                Imgproc.rectangle(frame, <span class="keyword">new</span> Point(left, top), <span class="keyword">new</span> Point(right, bottom),</div>
<div class="line">                                  <span class="keyword">new</span> Scalar(0, 255, 0));</div>
<div class="line">                String label = classNames[classId] + <span class="stringliteral">&quot;: &quot;</span> + confidence;</div>
<div class="line">                <span class="keywordtype">int</span>[] baseLine = <span class="keyword">new</span> <span class="keywordtype">int</span>[1];</div>
<div class="line">                Size labelSize = Imgproc.getTextSize(label, Imgproc.FONT_HERSHEY_SIMPLEX, 0.5, 1, baseLine);</div>
<div class="line"> </div>
<div class="line">                <span class="comment">// Draw background for label.</span></div>
<div class="line">                Imgproc.rectangle(frame, <span class="keyword">new</span> Point(left, top - labelSize.height),</div>
<div class="line">                                  <span class="keyword">new</span> Point(left + labelSize.width, top + baseLine[0]),</div>
<div class="line">                                  <span class="keyword">new</span> Scalar(255, 255, 255), Imgproc.FILLED);</div>
<div class="line">                <span class="comment">// Write class name and confidence.</span></div>
<div class="line">                Imgproc.putText(frame, label, <span class="keyword">new</span> Point(left, top),</div>
<div class="line">                        Imgproc.FONT_HERSHEY_SIMPLEX, 0.5, <span class="keyword">new</span> Scalar(0, 0, 0));</div>
<div class="line">            }</div>
<div class="line">        }</div>
</div><!-- fragment --><p><code>Dnn.blobFromImage</code> converts camera frame to neural network input tensor. Resize and statistical normalization are applied. Each line of network output tensor contains information on one detected object in the following order: confidence in range [0, 1], class id, left, top, right, bottom box coordinates. All coordinates are in range [0, 1] and should be scaled to image size before rendering.</p>
<ul>
<li>Launch an application and make a fun! <img src="../../11_demo.jpg" alt="" class="inline"/>     </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.6-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Jun 2 2024 21:52:14 for OpenCV by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.9.8
</small></address>
<script type="text/javascript">
//<![CDATA[
addTutorialsButtons();
//]]>
</script>
</body>
</html>
