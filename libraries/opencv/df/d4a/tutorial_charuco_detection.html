<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<title>OpenCV: Detection of ChArUco Boards</title>
<link href="../../opencv.ico" rel="shortcut icon" type="image/x-icon" />
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../tutorial-utils.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  },
  loader: {
    load: ['[tex]/ams']
  },
  tex: {
    macros: {},
    packages: ['base','configmacros','ams']
  }
};
//<![CDATA[
window.MathJax = {
    loader: {load: ['[tex]/ams']},
    tex: {
        packages: {'[+]': ['ams']},
        macros: {
            matTT: [ "\\[ \\left|\\begin{array}{ccc} #1 & #2 & #3\\\\ #4 & #5 & #6\\\\ #7 & #8 & #9 \\end{array}\\right| \\]", 9],
            fork: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ \\end{array} \\right.", 4],
            forkthree: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ #5 & \\mbox{#6}\\\\ \\end{array} \\right.", 6],
            forkfour: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ #5 & \\mbox{#6}\\\\ #7 & \\mbox{#8}\\\\ \\end{array} \\right.", 8],
            vecthree: ["\\begin{bmatrix} #1\\\\ #2\\\\ #3 \\end{bmatrix}", 3],
            vecthreethree: ["\\begin{bmatrix} #1 & #2 & #3\\\\ #4 & #5 & #6\\\\ #7 & #8 & #9 \\end{bmatrix}", 9],
            cameramatrix: ["#1 = \\begin{bmatrix} f_x & 0 & c_x\\\\ 0 & f_y & c_y\\\\ 0 & 0 & 1 \\end{bmatrix}", 1],
            distcoeffs: ["(k_1, k_2, p_1, p_2[, k_3[, k_4, k_5, k_6 [, s_1, s_2, s_3, s_4[, \\tau_x, \\tau_y]]]]) \\text{ of 4, 5, 8, 12 or 14 elements}"],
            distcoeffsfisheye: ["(k_1, k_2, k_3, k_4)"],
            hdotsfor: ["\\dots", 1],
            mathbbm: ["\\mathbb{#1}", 1],
            bordermatrix: ["\\matrix{#1}", 1]
        },
        processEscapes: false
    }
};
//]]>
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-chtml.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<!--#include virtual="/google-search.html"-->
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../opencv-logo-small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">OpenCV
   &#160;<span id="projectnumber">4.10.0</span>
   </div>
   <div id="projectbrief">Open Source Computer Vision</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../d9/df8/tutorial_root.html">OpenCV Tutorials</a></li><li class="navelem"><a class="el" href="../../d2/d64/tutorial_table_of_content_objdetect.html">Object Detection (objdetect module)</a></li>  </ul>
</div>
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Detection of ChArUco Boards</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>Prev Tutorial:</b> <a class="el" href="../../db/da9/tutorial_aruco_board_detection.html">Detection of ArUco boards</a> <br  />
<b>Next Tutorial:</b> <a class="el" href="../../d5/d07/tutorial_charuco_diamond_detection.html">Detection of Diamond Markers</a> <br  />
 ArUco markers and boards are very useful due to their fast detection and their versatility. However, one of the problems of ArUco markers is that the accuracy of their corner positions is not too high, even after applying subpixel refinement.</p>
<p>On the contrary, the corners of chessboard patterns can be refined more accurately since each corner is surrounded by two black squares. However, finding a chessboard pattern is not as versatile as finding an ArUco board: it has to be completely visible and occlusions are not permitted.</p>
<p>A ChArUco board tries to combine the benefits of these two approaches:</p>
<div class="image">
<img src="../../charucodefinition.png" alt=""/>
<div class="caption">
Charuco definition</div></div>
    <p>The ArUco part is used to interpolate the position of the chessboard corners, so that it has the versatility of marker boards, since it allows occlusions or partial views. Moreover, since the interpolated corners belong to a chessboard, they are very accurate in terms of subpixel accuracy.</p>
<p>When high precision is necessary, such as in camera calibration, Charuco boards are a better option than standard ArUco boards.</p>
<h1><a class="anchor" id="autotoc_md1080"></a>
Goal</h1>
<p>In this tutorial you will learn:</p>
<ul>
<li>How to create a charuco board ?</li>
<li>How to detect the charuco corners without performing camera calibration ?</li>
<li>How to detect the charuco corners with camera calibration and pose estimation ?</li>
</ul>
<h1><a class="anchor" id="autotoc_md1081"></a>
Source code</h1>
<p>You can find this code in <code>samples/cpp/tutorial_code/objectDetection/detect_board_charuco.cpp</code></p>
<p>Here's a sample code of how to achieve all the stuff enumerated at the goal list.</p>
<div class="fragment"><div class="line">    <span class="keywordtype">int</span> squaresX = parser.get&lt;<span class="keywordtype">int</span>&gt;(<span class="stringliteral">&quot;w&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> squaresY = parser.get&lt;<span class="keywordtype">int</span>&gt;(<span class="stringliteral">&quot;h&quot;</span>);</div>
<div class="line">    <span class="keywordtype">float</span> squareLength = parser.get&lt;<span class="keywordtype">float</span>&gt;(<span class="stringliteral">&quot;sl&quot;</span>);</div>
<div class="line">    <span class="keywordtype">float</span> markerLength = parser.get&lt;<span class="keywordtype">float</span>&gt;(<span class="stringliteral">&quot;ml&quot;</span>);</div>
<div class="line">    <span class="keywordtype">bool</span> refine = parser.has(<span class="stringliteral">&quot;rs&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> camId = parser.get&lt;<span class="keywordtype">int</span>&gt;(<span class="stringliteral">&quot;ci&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">string</span> video;</div>
<div class="line">    <span class="keywordflow">if</span>(parser.has(<span class="stringliteral">&quot;v&quot;</span>)) {</div>
<div class="line">        video = parser.get&lt;<span class="keywordtype">string</span>&gt;(<span class="stringliteral">&quot;v&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    Mat camMatrix, distCoeffs;</div>
<div class="line">    readCameraParamsFromCommandLine(parser, camMatrix, distCoeffs);</div>
<div class="line">    aruco::DetectorParameters detectorParams = readDetectorParamsFromCommandLine(parser);</div>
<div class="line">    aruco::Dictionary dictionary = readDictionatyFromCommandLine(parser);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>(!parser.check()) {</div>
<div class="line">        parser.printErrors();</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    VideoCapture inputVideo;</div>
<div class="line">    <span class="keywordtype">int</span> waitTime = 0;</div>
<div class="line">    <span class="keywordflow">if</span>(!video.empty()) {</div>
<div class="line">        inputVideo.open(video);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        inputVideo.open(camId);</div>
<div class="line">        waitTime = 10;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">float</span> axisLength = 0.5f * ((float)<a class="code hl_function" href="../../d2/de8/group__core__array.html#ga9af368f182ee76d0463d0d8d5330b764">min</a>(squaresX, squaresY) * (squareLength));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// create charuco board object</span></div>
<div class="line">    aruco::CharucoBoard charucoBoard(<a class="code hl_typedef" href="../../dc/d84/group__core__basic.html#ga346f563897249351a34549137c8532a0">Size</a>(squaresX, squaresY), squareLength, markerLength, dictionary);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// create charuco detector</span></div>
<div class="line">    aruco::CharucoParameters charucoParams;</div>
<div class="line">    charucoParams.tryRefineMarkers = refine; <span class="comment">// if tryRefineMarkers, refineDetectedMarkers() will be used in detectBoard()</span></div>
<div class="line">    charucoParams.cameraMatrix = camMatrix; <span class="comment">// cameraMatrix can be used in detectBoard()</span></div>
<div class="line">    charucoParams.distCoeffs = distCoeffs; <span class="comment">// distCoeffs can be used in detectBoard()</span></div>
<div class="line">    aruco::CharucoDetector charucoDetector(charucoBoard, charucoParams, detectorParams);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> totalTime = 0;</div>
<div class="line">    <span class="keywordtype">int</span> totalIterations = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span>(inputVideo.grab()) {</div>
<div class="line">        Mat image, imageCopy;</div>
<div class="line">        inputVideo.retrieve(image);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">double</span> tick = (double)<a class="code hl_function" href="../../db/de0/group__core__utils.html#gae73f58000611a1af25dd36d496bf4487">getTickCount</a>();</div>
<div class="line"> </div>
<div class="line">        vector&lt;int&gt; markerIds, charucoIds;</div>
<div class="line">        vector&lt;vector&lt;Point2f&gt; &gt; markerCorners;</div>
<div class="line">        vector&lt;Point2f&gt; charucoCorners;</div>
<div class="line">        <a class="code hl_typedef" href="../../dc/d84/group__core__basic.html#ga370d94209693b5b13437ab4991cabf73">Vec3d</a> rvec, tvec;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// detect markers and charuco corners</span></div>
<div class="line">        charucoDetector.detectBoard(image, charucoCorners, charucoIds, markerCorners, markerIds);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// estimate charuco board pose</span></div>
<div class="line">        <span class="keywordtype">bool</span> validPose = <span class="keyword">false</span>;</div>
<div class="line">        <span class="keywordflow">if</span>(camMatrix.total() != 0 &amp;&amp; distCoeffs.total() != 0 &amp;&amp; charucoIds.size() &gt;= 4) {</div>
<div class="line">            Mat objPoints, imgPoints;</div>
<div class="line">            charucoBoard.matchImagePoints(charucoCorners, charucoIds, objPoints, imgPoints);</div>
<div class="line">            validPose = <a class="code hl_function" href="../../d9/d0c/group__calib3d.html#ga549c2075fac14829ff4a58bc931c033d">solvePnP</a>(objPoints, imgPoints, camMatrix, distCoeffs, rvec, tvec);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">double</span> currentTime = ((double)<a class="code hl_function" href="../../db/de0/group__core__utils.html#gae73f58000611a1af25dd36d496bf4487">getTickCount</a>() - tick) / <a class="code hl_function" href="../../db/de0/group__core__utils.html#ga705441a9ef01f47acdc55d87fbe5090c">getTickFrequency</a>();</div>
<div class="line">        totalTime += currentTime;</div>
<div class="line">        totalIterations++;</div>
<div class="line">        <span class="keywordflow">if</span>(totalIterations % 30 == 0) {</div>
<div class="line">            cout &lt;&lt; <span class="stringliteral">&quot;Detection Time = &quot;</span> &lt;&lt; currentTime * 1000 &lt;&lt; <span class="stringliteral">&quot; ms &quot;</span></div>
<div class="line">                 &lt;&lt; <span class="stringliteral">&quot;(Mean = &quot;</span> &lt;&lt; 1000 * totalTime / double(totalIterations) &lt;&lt; <span class="stringliteral">&quot; ms)&quot;</span> &lt;&lt; endl;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// draw results</span></div>
<div class="line">        image.copyTo(imageCopy);</div>
<div class="line">        <span class="keywordflow">if</span>(markerIds.size() &gt; 0) {</div>
<div class="line">            aruco::drawDetectedMarkers(imageCopy, markerCorners);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span>(charucoIds.size() &gt; 0) {</div>
<div class="line">            aruco::drawDetectedCornersCharuco(imageCopy, charucoCorners, charucoIds, <a class="code hl_class" href="../../d1/da0/classcv_1_1Scalar__.html">cv::Scalar</a>(255, 0, 0));</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span>(validPose)</div>
<div class="line">            <a class="code hl_function" href="../../d9/d0c/group__calib3d.html#gab3ab7bb2bdfe7d5d9745bb92d13f9564">cv::drawFrameAxes</a>(imageCopy, camMatrix, distCoeffs, rvec, tvec, axisLength);</div>
<div class="line"> </div>
<div class="line">        <a class="code hl_function" href="../../d7/dfc/group__highgui.html#ga453d42fe4cb60e5723281a89973ee563">imshow</a>(<span class="stringliteral">&quot;out&quot;</span>, imageCopy);</div>
<div class="line">        <span class="keywordflow">if</span>(<a class="code hl_function" href="../../d7/dfc/group__highgui.html#ga5628525ad33f52eab17feebcfba38bd7">waitKey</a>(waitTime) == 27) <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="ttc" id="aclasscv_1_1Scalar___html"><div class="ttname"><a href="../../d1/da0/classcv_1_1Scalar__.html">cv::Scalar_&lt; double &gt;</a></div></div>
<div class="ttc" id="agroup__calib3d_html_ga549c2075fac14829ff4a58bc931c033d"><div class="ttname"><a href="../../d9/d0c/group__calib3d.html#ga549c2075fac14829ff4a58bc931c033d">cv::solvePnP</a></div><div class="ttdeci">bool solvePnP(InputArray objectPoints, InputArray imagePoints, InputArray cameraMatrix, InputArray distCoeffs, OutputArray rvec, OutputArray tvec, bool useExtrinsicGuess=false, int flags=SOLVEPNP_ITERATIVE)</div><div class="ttdoc">Finds an object pose from 3D-2D point correspondences.</div></div>
<div class="ttc" id="agroup__calib3d_html_gab3ab7bb2bdfe7d5d9745bb92d13f9564"><div class="ttname"><a href="../../d9/d0c/group__calib3d.html#gab3ab7bb2bdfe7d5d9745bb92d13f9564">cv::drawFrameAxes</a></div><div class="ttdeci">void drawFrameAxes(InputOutputArray image, InputArray cameraMatrix, InputArray distCoeffs, InputArray rvec, InputArray tvec, float length, int thickness=3)</div><div class="ttdoc">Draw axes of the world/object coordinate system from pose estimation.</div></div>
<div class="ttc" id="agroup__core__array_html_ga9af368f182ee76d0463d0d8d5330b764"><div class="ttname"><a href="../../d2/de8/group__core__array.html#ga9af368f182ee76d0463d0d8d5330b764">cv::min</a></div><div class="ttdeci">void min(InputArray src1, InputArray src2, OutputArray dst)</div><div class="ttdoc">Calculates per-element minimum of two arrays or an array and a scalar.</div></div>
<div class="ttc" id="agroup__core__basic_html_ga346f563897249351a34549137c8532a0"><div class="ttname"><a href="../../dc/d84/group__core__basic.html#ga346f563897249351a34549137c8532a0">cv::Size</a></div><div class="ttdeci">Size2i Size</div><div class="ttdef"><b>Definition</b> types.hpp:370</div></div>
<div class="ttc" id="agroup__core__basic_html_ga370d94209693b5b13437ab4991cabf73"><div class="ttname"><a href="../../dc/d84/group__core__basic.html#ga370d94209693b5b13437ab4991cabf73">cv::Vec3d</a></div><div class="ttdeci">Vec&lt; double, 3 &gt; Vec3d</div><div class="ttdef"><b>Definition</b> matx.hpp:464</div></div>
<div class="ttc" id="agroup__core__utils_html_ga705441a9ef01f47acdc55d87fbe5090c"><div class="ttname"><a href="../../db/de0/group__core__utils.html#ga705441a9ef01f47acdc55d87fbe5090c">cv::getTickFrequency</a></div><div class="ttdeci">double getTickFrequency()</div><div class="ttdoc">Returns the number of ticks per second.</div></div>
<div class="ttc" id="agroup__core__utils_html_gae73f58000611a1af25dd36d496bf4487"><div class="ttname"><a href="../../db/de0/group__core__utils.html#gae73f58000611a1af25dd36d496bf4487">cv::getTickCount</a></div><div class="ttdeci">int64 getTickCount()</div><div class="ttdoc">Returns the number of ticks.</div></div>
<div class="ttc" id="agroup__highgui_html_ga453d42fe4cb60e5723281a89973ee563"><div class="ttname"><a href="../../d7/dfc/group__highgui.html#ga453d42fe4cb60e5723281a89973ee563">cv::imshow</a></div><div class="ttdeci">void imshow(const String &amp;winname, InputArray mat)</div><div class="ttdoc">Displays an image in the specified window.</div></div>
<div class="ttc" id="agroup__highgui_html_ga5628525ad33f52eab17feebcfba38bd7"><div class="ttname"><a href="../../d7/dfc/group__highgui.html#ga5628525ad33f52eab17feebcfba38bd7">cv::waitKey</a></div><div class="ttdeci">int waitKey(int delay=0)</div><div class="ttdoc">Waits for a pressed key.</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md1082"></a>
ChArUco Board Creation</h1>
<p>The aruco module provides the <code><a class="el" href="../../d0/d3c/classcv_1_1aruco_1_1CharucoBoard.html" title="ChArUco board is a planar chessboard where the markers are placed inside the white squares of a chess...">cv::aruco::CharucoBoard</a></code> class that represents a Charuco Board and which inherits from the <code><a class="el" href="../../d4/db2/classcv_1_1aruco_1_1Board.html" title="Board of ArUco markers.">cv::aruco::Board</a></code> class.</p>
<p>This class, as the rest of ChArUco functionalities, are defined in:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../dc/d25/charuco__detector_8hpp.html">opencv2/objdetect/charuco_detector.hpp</a>&gt;</span></div>
<div class="ttc" id="acharuco__detector_8hpp_html"><div class="ttname"><a href="../../dc/d25/charuco__detector_8hpp.html">charuco_detector.hpp</a></div></div>
</div><!-- fragment --><p>To define a <code><a class="el" href="../../d0/d3c/classcv_1_1aruco_1_1CharucoBoard.html" title="ChArUco board is a planar chessboard where the markers are placed inside the white squares of a chess...">cv::aruco::CharucoBoard</a></code>, it is necessary:</p>
<ul>
<li>Number of chessboard squares in X and Y directions.</li>
<li>Length of square side.</li>
<li>Length of marker side.</li>
<li>The dictionary of the markers.</li>
<li>Ids of all the markers.</li>
</ul>
<p>As for the <code><a class="el" href="../../de/d05/classcv_1_1aruco_1_1GridBoard.html" title="Planar board with grid arrangement of markers.">cv::aruco::GridBoard</a></code> objects, the aruco module provides to create <code><a class="el" href="../../d0/d3c/classcv_1_1aruco_1_1CharucoBoard.html" title="ChArUco board is a planar chessboard where the markers are placed inside the white squares of a chess...">cv::aruco::CharucoBoard</a></code> easily. This object can be easily created from these parameters using the <code><a class="el" href="../../d0/d3c/classcv_1_1aruco_1_1CharucoBoard.html" title="ChArUco board is a planar chessboard where the markers are placed inside the white squares of a chess...">cv::aruco::CharucoBoard</a></code> constructor:</p>
<div class="fragment"><div class="line">    aruco::Dictionary dictionary = readDictionatyFromCommandLine(parser);</div>
<div class="line">    <a class="code hl_class" href="../../d0/d3c/classcv_1_1aruco_1_1CharucoBoard.html">cv::aruco::CharucoBoard</a> board(Size(squaresX, squaresY), (<span class="keywordtype">float</span>)squareLength, (<span class="keywordtype">float</span>)markerLength, dictionary);</div>
<div class="ttc" id="aclasscv_1_1aruco_1_1CharucoBoard_html"><div class="ttname"><a href="../../d0/d3c/classcv_1_1aruco_1_1CharucoBoard.html">cv::aruco::CharucoBoard</a></div><div class="ttdoc">ChArUco board is a planar chessboard where the markers are placed inside the white squares of a chess...</div><div class="ttdef"><b>Definition</b> aruco_board.hpp:135</div></div>
</div><!-- fragment --><ul>
<li>The first parameter is the number of squares in X and Y direction respectively.</li>
<li>The second and third parameters are the length of the squares and the markers respectively. They can be provided in any unit, having in mind that the estimated pose for this board would be measured in the same units (usually meters are used).</li>
<li>Finally, the dictionary of the markers is provided.</li>
</ul>
<p>The ids of each of the markers are assigned by default in ascending order and starting on 0, like in <code><a class="el" href="../../de/d05/classcv_1_1aruco_1_1GridBoard.html" title="Planar board with grid arrangement of markers.">cv::aruco::GridBoard</a></code> constructor. This can be easily customized by accessing to the ids vector through <code>board.ids</code>, like in the <code><a class="el" href="../../d4/db2/classcv_1_1aruco_1_1Board.html" title="Board of ArUco markers.">cv::aruco::Board</a></code> parent class.</p>
<p>Once we have our <code><a class="el" href="../../d0/d3c/classcv_1_1aruco_1_1CharucoBoard.html" title="ChArUco board is a planar chessboard where the markers are placed inside the white squares of a chess...">cv::aruco::CharucoBoard</a></code> object, we can create an image to print it. There are two ways to do this:</p><ol type="1">
<li>By using the script <code>doc/patter_tools/gen_pattern.py</code>, see <a class="el" href="../../da/d0d/tutorial_camera_calibration_pattern.html">Create calibration pattern</a>.</li>
<li>By using the function <code><a class="el" href="../../d4/db2/classcv_1_1aruco_1_1Board.html#a25b6823cad11256f1043bfd0e51b7c14" title="Draw a planar board.">cv::aruco::CharucoBoard::generateImage()</a></code>.</li>
</ol>
<p>The function <code><a class="el" href="../../d4/db2/classcv_1_1aruco_1_1Board.html#a25b6823cad11256f1043bfd0e51b7c14" title="Draw a planar board.">cv::aruco::CharucoBoard::generateImage()</a></code> is provided in <a class="el" href="../../d0/d3c/classcv_1_1aruco_1_1CharucoBoard.html" title="ChArUco board is a planar chessboard where the markers are placed inside the white squares of a chess...">cv::aruco::CharucoBoard</a> class and can be called by using the following code: </p><div class="fragment"><div class="line">    Mat boardImage;</div>
<div class="line">    Size imageSize;</div>
<div class="line">    imageSize.<a class="code hl_variable" href="../../d6/d50/classcv_1_1Size__.html#abfe0367b32c407ddccf5ddf92667c73d">width</a> = squaresX * squareLength + 2 * margins;</div>
<div class="line">    imageSize.height = squaresY * squareLength + 2 * margins;</div>
<div class="line">    board.generateImage(imageSize, boardImage, margins, borderBits);</div>
<div class="ttc" id="aclasscv_1_1Size___html_abfe0367b32c407ddccf5ddf92667c73d"><div class="ttname"><a href="../../d6/d50/classcv_1_1Size__.html#abfe0367b32c407ddccf5ddf92667c73d">cv::Size_::width</a></div><div class="ttdeci">_Tp width</div><div class="ttdoc">the width</div><div class="ttdef"><b>Definition</b> types.hpp:362</div></div>
</div><!-- fragment --><ul>
<li>The first parameter is the size of the output image in pixels. If this is not proportional to the board dimensions, it will be centered on the image.</li>
<li>The second parameter is the output image with the charuco board.</li>
<li>The third parameter is the (optional) margin in pixels, so none of the markers are touching the image border.</li>
<li>Finally, the size of the marker border, similarly to <code><a class="el" href="../../de/d67/group__objdetect__aruco.html#ga631cb40c63945cc5b9ef6b064a5f4fc2" title="Generate a canonical marker image.">cv::aruco::generateImageMarker()</a></code> function. The default value is 1.</li>
</ul>
<p>The output image will be something like this:</p>
<div class="image">
<img src="../../charucoboard.png" alt=""/>
</div>
    <p>A full working example is included in the <code>create_board_charuco.cpp</code> inside the <code>samples/cpp/tutorial_code/objectDetection/</code>.</p>
<p>The samples <code>create_board_charuco.cpp</code> now take input via commandline via the <code><a class="el" href="../../d0/d2e/classcv_1_1CommandLineParser.html" title="Designed for command line parsing.">cv::CommandLineParser</a></code>. For this file the example parameters will look like: </p><div class="fragment"><div class="line"><span class="stringliteral">&quot;_output_path_/chboard.png&quot;</span> -w=5 -h=7 -sl=100 -ml=60 -d=10</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md1083"></a>
ChArUco Board Detection</h1>
<p>When you detect a ChArUco board, what you are actually detecting is each of the chessboard corners of the board.</p>
<p>Each corner on a ChArUco board has a unique identifier (id) assigned. These ids go from 0 to the total number of corners in the board. The steps of charuco board detection can be broken down to the following steps:</p>
<ul>
<li><b>Taking input Image</b></li>
</ul>
<div class="fragment"><div class="line">        Mat image, imageCopy;</div>
<div class="line">        inputVideo.retrieve(image);</div>
</div><!-- fragment --><p>The original image where the markers are to be detected. The image is necessary to perform subpixel refinement in the ChArUco corners.</p>
<ul>
<li><b>Reading the camera calibration Parameters(only for detection with camera calibration)</b></li>
</ul>
<div class="fragment"><div class="line">    <span class="keywordflow">if</span>(parser.has(<span class="stringliteral">&quot;c&quot;</span>)) {</div>
<div class="line">        <span class="keywordtype">bool</span> readOk = readCameraParameters(parser.get&lt;std::string&gt;(<span class="stringliteral">&quot;c&quot;</span>), camMatrix, distCoeffs);</div>
<div class="line">        <span class="keywordflow">if</span>(!readOk) {</div>
<div class="line">            <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Invalid camera file\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
</div><!-- fragment --><p>The parameters of <code>readCameraParameters</code> are:</p><ul>
<li>The first parameter is the path to the camera intrinsic matrix and distortion coefficients.</li>
<li>The second and third parameters are cameraMatrix and distCoeffs.</li>
</ul>
<p>This function takes these parameters as input and returns a boolean value of whether the camera calibration parameters are valid or not. For detection of charuco corners without calibration, this step is not required.</p>
<ul>
<li><b>Detecting the markers and interpolation of charuco corners from markers</b></li>
</ul>
<p>The detection of the ChArUco corners is based on the previous detected markers. So that, first markers are detected, and then ChArUco corners are interpolated from markers. The method that detect the ChArUco corners is <code><a class="el" href="../../d9/df5/classcv_1_1aruco_1_1CharucoDetector.html#aacbea601612a3a0feaa45ebb7fb255fd" title="detect aruco markers and interpolate position of ChArUco board corners">cv::aruco::CharucoDetector::detectBoard()</a></code>.</p>
<div class="fragment"><div class="line">        <span class="comment">// detect markers and charuco corners</span></div>
<div class="line">        charucoDetector.detectBoard(image, charucoCorners, charucoIds, markerCorners, markerIds);</div>
</div><!-- fragment --><p>The parameters of detectBoard are:</p><ul>
<li><code>image</code> - Input image.</li>
<li><code>charucoCorners</code> - output list of image positions of the detected corners.</li>
<li><code>charucoIds</code> - output ids for each of the detected corners in <code>charucoCorners</code>.</li>
<li><code>markerCorners</code> - input/output vector of detected marker corners.</li>
<li><code>markerIds</code> - input/output vector of identifiers of the detected markers</li>
</ul>
<p>If markerCorners and markerIds are empty, the function will detect aruco markers and ids.</p>
<p>If calibration parameters are provided, the ChArUco corners are interpolated by, first, estimating a rough pose from the ArUco markers and, then, reprojecting the ChArUco corners back to the image.</p>
<p>On the other hand, if calibration parameters are not provided, the ChArUco corners are interpolated by calculating the corresponding homography between the ChArUco plane and the ChArUco image projection.</p>
<p>The main problem of using homography is that the interpolation is more sensible to image distortion. Actually, the homography is only performed using the closest markers of each ChArUco corner to reduce the effect of distortion.</p>
<p>When detecting markers for ChArUco boards, and specially when using homography, it is recommended to disable the corner refinement of markers. The reason of this is that, due to the proximity of the chessboard squares, the subpixel process can produce important deviations in the corner positions and these deviations are propagated to the ChArUco corner interpolation, producing poor results.</p>
<dl class="section note"><dt>Note</dt><dd>To avoid deviations, the margin between chessboard square and aruco marker should be greater than 70% of one marker module.</dd></dl>
<p>Furthermore, only those corners whose two surrounding markers have be found are returned. If any of the two surrounding markers has not been detected, this usually means that there is some occlusion or the image quality is not good in that zone. In any case, it is preferable not to consider that corner, since what we want is to be sure that the interpolated ChArUco corners are very accurate.</p>
<p>After the ChArUco corners have been interpolated, a subpixel refinement is performed.</p>
<p>Once we have interpolated the ChArUco corners, we would probably want to draw them to see if their detections are correct. This can be easily done using the <code><a class="el" href="../../de/d67/group__objdetect__aruco.html#ga7225eee644190f791e1583c499b7ab10" title="Draws a set of Charuco corners.">cv::aruco::drawDetectedCornersCharuco()</a></code> function:</p>
<div class="fragment"><div class="line">            aruco::drawDetectedCornersCharuco(imageCopy, charucoCorners, charucoIds, <a class="code hl_class" href="../../d1/da0/classcv_1_1Scalar__.html">cv::Scalar</a>(255, 0, 0));</div>
</div><!-- fragment --><ul>
<li><code>imageCopy</code> is the image where the corners will be drawn (it will normally be the same image where the corners were detected).</li>
<li>The <code>outputImage</code> will be a clone of <code>inputImage</code> with the corners drawn.</li>
<li><code>charucoCorners</code> and <code>charucoIds</code> are the detected Charuco corners from the <code><a class="el" href="../../d9/df5/classcv_1_1aruco_1_1CharucoDetector.html#aacbea601612a3a0feaa45ebb7fb255fd" title="detect aruco markers and interpolate position of ChArUco board corners">cv::aruco::CharucoDetector::detectBoard()</a></code> function.</li>
<li>Finally, the last parameter is the (optional) color we want to draw the corners with, of type <code><a class="el" href="../../dc/d84/group__core__basic.html#ga599fe92e910c027be274233eccad7beb">cv::Scalar</a></code>.</li>
</ul>
<p>For this image:</p>
<div class="image">
<img src="../../choriginal.jpg" alt=""/>
<div class="caption">
Image with Charuco board</div></div>
    <p>The result will be:</p>
<div class="image">
<img src="../../chcorners.jpg" alt=""/>
<div class="caption">
Charuco board detected</div></div>
    <p>In the presence of occlusion. like in the following image, although some corners are clearly visible, not all their surrounding markers have been detected due occlusion and, thus, they are not interpolated:</p>
<div class="image">
<img src="../../chocclusion.jpg" alt=""/>
<div class="caption">
Charuco detection with occlusion</div></div>
    <p>Sample video:</p>
<div align='center'><iframe title='Video' width='560' height='349' src='https://www.youtube.com/embed/Nj44m_N_9FY?rel=0' frameborder='0' align='middle' allowfullscreen></iframe></div><p>A full working example is included in the <code>detect_board_charuco.cpp</code> inside the <code>samples/cpp/tutorial_code/objectDetection/</code>.</p>
<p>The samples <code>detect_board_charuco.cpp</code> now take input via commandline via the <code><a class="el" href="../../d0/d2e/classcv_1_1CommandLineParser.html" title="Designed for command line parsing.">cv::CommandLineParser</a></code>. For this file the example parameters will look like: </p><div class="fragment"><div class="line">-w=5 -h=7 -sl=0.04 -ml=0.02 -d=10 -v=/path_to_opencv/opencv/doc/tutorials/objdetect/charuco_detection/images/choriginal.jpg</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md1084"></a>
ChArUco Pose Estimation</h1>
<p>The final goal of the ChArUco boards is finding corners very accurately for a high precision calibration or pose estimation.</p>
<p>The aruco module provides a function to perform ChArUco pose estimation easily. As in the <code><a class="el" href="../../de/d05/classcv_1_1aruco_1_1GridBoard.html" title="Planar board with grid arrangement of markers.">cv::aruco::GridBoard</a></code>, the coordinate system of the <code><a class="el" href="../../d0/d3c/classcv_1_1aruco_1_1CharucoBoard.html" title="ChArUco board is a planar chessboard where the markers are placed inside the white squares of a chess...">cv::aruco::CharucoBoard</a></code> is placed in the board plane with the Z axis pointing in, and centered in the bottom left corner of the board.</p>
<dl class="section note"><dt>Note</dt><dd>After OpenCV 4.6.0, there was an incompatible change in the coordinate systems of the boards, now the coordinate systems are placed in the boards plane with the Z axis pointing in the plane (previously the axis pointed out the plane). <code>objPoints</code> in CW order correspond to the Z-axis pointing in the plane. <code>objPoints</code> in CCW order correspond to the Z-axis pointing out the plane. See PR <a href="https://github.com/opencv/opencv_contrib/pull/3174">https://github.com/opencv/opencv_contrib/pull/3174</a></dd></dl>
<p>To perform pose estimation for charuco boards, you should use <code><a class="el" href="../../d4/db2/classcv_1_1aruco_1_1Board.html#a305c3c47c1f87562ed06de5c7e703e4f" title="Given a board configuration and a set of detected markers, returns the corresponding image points and...">cv::aruco::CharucoBoard::matchImagePoints()</a></code> and <code><a class="el" href="../../d9/d0c/group__calib3d.html#ga549c2075fac14829ff4a58bc931c033d" title="Finds an object pose from 3D-2D point correspondences.">cv::solvePnP()</a></code>:</p>
<div class="fragment"><div class="line">        <span class="comment">// estimate charuco board pose</span></div>
<div class="line">        <span class="keywordtype">bool</span> validPose = <span class="keyword">false</span>;</div>
<div class="line">        <span class="keywordflow">if</span>(camMatrix.total() != 0 &amp;&amp; distCoeffs.total() != 0 &amp;&amp; charucoIds.size() &gt;= 4) {</div>
<div class="line">            Mat objPoints, imgPoints;</div>
<div class="line">            charucoBoard.matchImagePoints(charucoCorners, charucoIds, objPoints, imgPoints);</div>
<div class="line">            validPose = solvePnP(objPoints, imgPoints, camMatrix, distCoeffs, rvec, tvec);</div>
<div class="line">        }</div>
</div><!-- fragment --><ul>
<li>The <code>charucoCorners</code> and <code>charucoIds</code> parameters are the detected charuco corners from the <code><a class="el" href="../../d9/df5/classcv_1_1aruco_1_1CharucoDetector.html#aacbea601612a3a0feaa45ebb7fb255fd" title="detect aruco markers and interpolate position of ChArUco board corners">cv::aruco::CharucoDetector::detectBoard()</a></code> function.</li>
<li>The <code>cameraMatrix</code> and <code>distCoeffs</code> are the camera calibration parameters which are necessary for pose estimation.</li>
<li>Finally, the <code>rvec</code> and <code>tvec</code> parameters are the output pose of the Charuco Board.</li>
<li><code><a class="el" href="../../d9/d0c/group__calib3d.html#ga549c2075fac14829ff4a58bc931c033d" title="Finds an object pose from 3D-2D point correspondences.">cv::solvePnP()</a></code> returns true if the pose was correctly estimated and false otherwise. The main reason of failing is that there are not enough corners for pose estimation or they are in the same line.</li>
</ul>
<p>The axis can be drawn using <code><a class="el" href="../../d9/d0c/group__calib3d.html#gab3ab7bb2bdfe7d5d9745bb92d13f9564" title="Draw axes of the world/object coordinate system from pose estimation.">cv::drawFrameAxes()</a></code> to check the pose is correctly estimated. The result would be: (X:red, Y:green, Z:blue)</p>
<div class="image">
<img src="../../chaxis.jpg" alt=""/>
<div class="caption">
Charuco Board Axis</div></div>
    <p>A full working example is included in the <code>detect_board_charuco.cpp</code> inside the <code>samples/cpp/tutorial_code/objectDetection/</code>.</p>
<p>The samples <code>detect_board_charuco.cpp</code> now take input via commandline via the <code><a class="el" href="../../d0/d2e/classcv_1_1CommandLineParser.html" title="Designed for command line parsing.">cv::CommandLineParser</a></code>. For this file the example parameters will look like: </p><div class="fragment"><div class="line">-w=5 -h=7 -sl=0.04 -ml=0.02 -d=10</div>
<div class="line">-v=/path_to_opencv/opencv/doc/tutorials/objdetect/charuco_detection/images/choriginal.jpg</div>
<div class="line">-c=/path_to_opencv/opencv/samples/cpp/tutorial_code/objectDetection/tutorial_camera_charuco.yml</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.6-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Jun 2 2024 21:52:14 for OpenCV by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.9.8
</small></address>
<script type="text/javascript">
//<![CDATA[
addTutorialsButtons();
//]]>
</script>
</body>
</html>
