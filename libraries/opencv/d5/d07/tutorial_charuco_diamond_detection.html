<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<title>OpenCV: Detection of Diamond Markers</title>
<link href="../../opencv.ico" rel="shortcut icon" type="image/x-icon" />
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../tutorial-utils.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  },
  loader: {
    load: ['[tex]/ams']
  },
  tex: {
    macros: {},
    packages: ['base','configmacros','ams']
  }
};
//<![CDATA[
window.MathJax = {
    loader: {load: ['[tex]/ams']},
    tex: {
        packages: {'[+]': ['ams']},
        macros: {
            matTT: [ "\\[ \\left|\\begin{array}{ccc} #1 & #2 & #3\\\\ #4 & #5 & #6\\\\ #7 & #8 & #9 \\end{array}\\right| \\]", 9],
            fork: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ \\end{array} \\right.", 4],
            forkthree: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ #5 & \\mbox{#6}\\\\ \\end{array} \\right.", 6],
            forkfour: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ #5 & \\mbox{#6}\\\\ #7 & \\mbox{#8}\\\\ \\end{array} \\right.", 8],
            vecthree: ["\\begin{bmatrix} #1\\\\ #2\\\\ #3 \\end{bmatrix}", 3],
            vecthreethree: ["\\begin{bmatrix} #1 & #2 & #3\\\\ #4 & #5 & #6\\\\ #7 & #8 & #9 \\end{bmatrix}", 9],
            cameramatrix: ["#1 = \\begin{bmatrix} f_x & 0 & c_x\\\\ 0 & f_y & c_y\\\\ 0 & 0 & 1 \\end{bmatrix}", 1],
            distcoeffs: ["(k_1, k_2, p_1, p_2[, k_3[, k_4, k_5, k_6 [, s_1, s_2, s_3, s_4[, \\tau_x, \\tau_y]]]]) \\text{ of 4, 5, 8, 12 or 14 elements}"],
            distcoeffsfisheye: ["(k_1, k_2, k_3, k_4)"],
            hdotsfor: ["\\dots", 1],
            mathbbm: ["\\mathbb{#1}", 1],
            bordermatrix: ["\\matrix{#1}", 1]
        },
        processEscapes: false
    }
};
//]]>
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-chtml.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<!--#include virtual="/google-search.html"-->
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../opencv-logo-small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">OpenCV
   &#160;<span id="projectnumber">4.10.0</span>
   </div>
   <div id="projectbrief">Open Source Computer Vision</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../d9/df8/tutorial_root.html">OpenCV Tutorials</a></li><li class="navelem"><a class="el" href="../../d2/d64/tutorial_table_of_content_objdetect.html">Object Detection (objdetect module)</a></li>  </ul>
</div>
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Detection of Diamond Markers</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>Prev Tutorial:</b> <a class="el" href="../../df/d4a/tutorial_charuco_detection.html">Detection of ChArUco Boards</a> <br  />
<b>Next Tutorial:</b> <a class="el" href="../../da/d13/tutorial_aruco_calibration.html">Calibration with ArUco and ChArUco</a> <br  />
 A ChArUco diamond marker (or simply diamond marker) is a chessboard composed by 3x3 squares and 4 ArUco markers inside the white squares. It is similar to a ChArUco board in appearance, however they are conceptually different.</p>
<div class="image">
<img src="../../diamondmarkers.jpg" alt=""/>
<div class="caption">
Diamond marker examples</div></div>
    <p>In both, ChArUco board and Diamond markers, their detection is based on the previous detected ArUco markers. In the ChArUco case, the used markers are selected by directly looking their identifiers. This means that if a marker (included in the board) is found on a image, it will be automatically assumed to belong to the board. Furthermore, if a marker board is found more than once in the image, it will produce an ambiguity since the system wont be able to know which one should be used for the Board.</p>
<p>On the other hand, the detection of Diamond marker is not based on the identifiers. Instead, their detection is based on the relative position of the markers. As a consequence, marker identifiers can be repeated in the same diamond or among different diamonds, and they can be detected simultaneously without ambiguity. However, due to the complexity of finding marker based on their relative position, the diamond markers are limited to a size of 3x3 squares and 4 markers.</p>
<p>As in a single ArUco marker, each Diamond marker is composed by 4 corners and a identifier. The four corners correspond to the 4 chessboard corners in the marker and the identifier is actually an array of 4 numbers, which are the identifiers of the four ArUco markers inside the diamond.</p>
<p>Diamond markers are useful in those scenarios where repeated markers should be allowed. For instance:</p>
<ul>
<li>To increase the number of identifiers of single markers by using diamond marker for labeling. They would allow up to N^4 different ids, being N the number of markers in the used dictionary.</li>
<li>Give to each of the four markers a conceptual meaning. For instance, one of the four marker ids could be used to indicate the scale of the marker (i.e. the size of the square), so that the same diamond can be found in the environment with different sizes just by changing one of the four markers and the user does not need to manually indicate the scale of each of them. This case is included in the <code>detect_diamonds.cpp</code> file inside the samples folder of the module.</li>
</ul>
<p>Furthermore, as its corners are chessboard corners, they can be used for accurate pose estimation.</p>
<p>The diamond functionalities are included in <code>&lt;<a class="el" href="../../dc/d25/charuco__detector_8hpp.html">opencv2/objdetect/charuco_detector.hpp</a>&gt;</code></p>
<h1><a class="anchor" id="autotoc_md1085"></a>
ChArUco Diamond Creation</h1>
<p>The image of a diamond marker can be easily created using the <code><a class="el" href="../../d4/db2/classcv_1_1aruco_1_1Board.html#a25b6823cad11256f1043bfd0e51b7c14" title="Draw a planar board.">cv::aruco::CharucoBoard::generateImage()</a></code> function. For instance:</p>
<div class="fragment"><div class="line">    vector&lt;int&gt; diamondIds = {ids[0], ids[1], ids[2], ids[3]};</div>
<div class="line">    aruco::CharucoBoard charucoBoard(Size(3, 3), (<span class="keywordtype">float</span>)squareLength, (<span class="keywordtype">float</span>)markerLength, dictionary, diamondIds);</div>
<div class="line">    Mat markerImg;</div>
<div class="line">    charucoBoard.generateImage(Size(3*squareLength + 2*margins, 3*squareLength + 2*margins), markerImg, margins, borderBits);</div>
</div><!-- fragment --><p>This will create a diamond marker image with a square size of 200 pixels and a marker size of 120 pixels. The marker ids are given in the second parameter as a <code><a class="el" href="../../dc/d84/group__core__basic.html#ga94ce799099ae6cdd66685e3fd0cad7d7">cv::Vec4i</a></code> object. The order of the marker ids in the diamond layout are the same as in a standard ChArUco board, i.e. top, left, right and bottom.</p>
<p>The image produced will be:</p>
<div class="image">
<img src="../../diamondmarker.png" alt=""/>
<div class="caption">
Diamond marker</div></div>
    <p>A full working example is included in the <code>create_diamond.cpp</code> inside the <code>samples/cpp/tutorial_code/objectDetection/</code>.</p>
<p>The samples <code>create_diamond.cpp</code> now take input via commandline via the <code><a class="el" href="../../d0/d2e/classcv_1_1CommandLineParser.html" title="Designed for command line parsing.">cv::CommandLineParser</a></code>. For this file the example parameters will look like: </p><div class="fragment"><div class="line"><span class="stringliteral">&quot;_path_/mydiamond.png&quot;</span> -sl=200 -ml=120 -d=10 -ids=0,1,2,3</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md1086"></a>
ChArUco Diamond Detection</h1>
<p>As in most cases, the detection of diamond markers requires a previous detection of ArUco markers. After detecting markers, diamond are detected using the <code><a class="el" href="../../d9/df5/classcv_1_1aruco_1_1CharucoDetector.html#a7c8f2d11dd861f8071c5362d9c1fd0e7" title="Detect ChArUco Diamond markers.">cv::aruco::CharucoDetector::detectDiamonds()</a></code> function:</p>
<div class="fragment"><div class="line">        vector&lt;int&gt; markerIds;</div>
<div class="line">        vector&lt;Vec4i&gt; diamondIds;</div>
<div class="line">        vector&lt;vector&lt;Point2f&gt; &gt; markerCorners, diamondCorners;</div>
<div class="line">        vector&lt;Vec3d&gt; rvecs, tvecs;</div>
<div class="line"> </div>
<div class="line">        detector.detectDiamonds(image, diamondCorners, diamondIds, markerCorners, markerIds);</div>
</div><!-- fragment --><p>The <code><a class="el" href="../../d9/df5/classcv_1_1aruco_1_1CharucoDetector.html#a7c8f2d11dd861f8071c5362d9c1fd0e7" title="Detect ChArUco Diamond markers.">cv::aruco::CharucoDetector::detectDiamonds()</a></code> function receives the original image and the previous detected marker corners and ids. If markerCorners and markerIds are empty, the function will detect aruco markers and ids. The input image is necessary to perform subpixel refinement in the ChArUco corners. It also receives the rate between the square size and the marker sizes which is required for both, detecting the diamond from the relative positions of the markers and interpolating the ChArUco corners.</p>
<p>The function returns the detected diamonds in two parameters. The first parameter, <code>diamondCorners</code>, is an array containing all the four corners of each detected diamond. Its format is similar to the detected corners by the <code><a class="el" href="../../d2/d1a/classcv_1_1aruco_1_1ArucoDetector.html#a0c1d14251bf1cbb06277f49cfe1c9b61" title="Basic marker detection.">cv::aruco::ArucoDetector::detectMarkers()</a></code> function and, for each diamond, the corners are represented in the same order than in the ArUco markers, i.e. clockwise order starting with the top-left corner. The second returned parameter, <code>diamondIds</code>, contains all the ids of the returned diamond corners in <code>diamondCorners</code>. Each id is actually an array of 4 integers that can be represented with <code><a class="el" href="../../dc/d84/group__core__basic.html#ga94ce799099ae6cdd66685e3fd0cad7d7">cv::Vec4i</a></code>.</p>
<p>The detected diamond can be visualized using the function <code><a class="el" href="../../de/d67/group__objdetect__aruco.html#ga0dbf27203267fb8e9f282554cf0d3433" title="Draw a set of detected ChArUco Diamond markers.">cv::aruco::drawDetectedDiamonds()</a></code> which simply receives the image and the diamond corners and ids:</p>
<div class="fragment"><div class="line">        <span class="keywordflow">if</span>(diamondIds.size() &gt; 0) {</div>
<div class="line">            aruco::drawDetectedDiamonds(imageCopy, diamondCorners, diamondIds);</div>
</div><!-- fragment --><p>The result is the same that the one produced by <code><a class="el" href="../../de/d67/group__objdetect__aruco.html#ga2ad34b0f277edebb6a132d3069ed2909" title="Draw detected markers in image.">cv::aruco::drawDetectedMarkers()</a></code>, but printing the four ids of the diamond:</p>
<div class="image">
<img src="../../detecteddiamonds.jpg" alt=""/>
<div class="caption">
Detected diamond markers</div></div>
    <p>A full working example is included in the <code>detect_diamonds.cpp</code> inside the <code>samples/cpp/tutorial_code/objectDetection/</code>.</p>
<p>The samples <code>detect_diamonds.cpp</code> now take input via commandline via the <code><a class="el" href="../../d0/d2e/classcv_1_1CommandLineParser.html" title="Designed for command line parsing.">cv::CommandLineParser</a></code>. For this file the example parameters will look like: </p><div class="fragment"><div class="line">-dp=path_to_opencv/opencv/samples/cpp/tutorial_code/objectDetection/detector_params.yml -sl=0.4 -ml=0.25 -refine=3</div>
<div class="line">-v=path_to_opencv/opencv/doc/tutorials/objdetect/charuco_diamond_detection/images/diamondmarkers.jpg</div>
<div class="line">-cd=path_to_opencv/opencv/samples/cpp/tutorial_code/objectDetection/tutorial_dict.yml</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md1087"></a>
ChArUco Diamond Pose Estimation</h1>
<p>Since a ChArUco diamond is represented by its four corners, its pose can be estimated in the same way than in a single ArUco marker, i.e. using the <code><a class="el" href="../../d9/d0c/group__calib3d.html#ga549c2075fac14829ff4a58bc931c033d" title="Finds an object pose from 3D-2D point correspondences.">cv::solvePnP()</a></code> function. For instance:</p>
<div class="fragment"><div class="line">        <span class="comment">// estimate diamond pose</span></div>
<div class="line">        <span class="keywordtype">size_t</span> N = diamondIds.size();</div>
<div class="line">        <span class="keywordflow">if</span>(estimatePose &amp;&amp; N &gt; 0) {</div>
<div class="line">            <a class="code hl_class" href="../../d3/d63/classcv_1_1Mat.html">cv::Mat</a> objPoints(4, 1, <a class="code hl_define" href="../../d1/d1b/group__core__hal__interface.html#ga0610d99405b809062622588c25ed5c8f">CV_32FC3</a>);</div>
<div class="line">            rvecs.resize(N);</div>
<div class="line">            tvecs.resize(N);</div>
<div class="line">            <span class="keywordflow">if</span>(!autoScale) {</div>
<div class="line">                <span class="comment">// set coordinate system</span></div>
<div class="line">                objPoints.ptr&lt;Vec3f&gt;(0)[0] = Vec3f(-squareLength/2.f, squareLength/2.f, 0);</div>
<div class="line">                objPoints.ptr&lt;Vec3f&gt;(0)[1] = Vec3f(squareLength/2.f, squareLength/2.f, 0);</div>
<div class="line">                objPoints.ptr&lt;Vec3f&gt;(0)[2] = Vec3f(squareLength/2.f, -squareLength/2.f, 0);</div>
<div class="line">                objPoints.ptr&lt;Vec3f&gt;(0)[3] = Vec3f(-squareLength/2.f, -squareLength/2.f, 0);</div>
<div class="line">                <span class="comment">// Calculate pose for each marker</span></div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0ull; i &lt; N; i++)</div>
<div class="line">                    solvePnP(objPoints, diamondCorners.at(i), camMatrix, distCoeffs, rvecs.at(i), tvecs.at(i));</div>
<div class="ttc" id="aclasscv_1_1Mat_html"><div class="ttname"><a href="../../d3/d63/classcv_1_1Mat.html">cv::Mat</a></div><div class="ttdoc">n-dimensional dense array class</div><div class="ttdef"><b>Definition</b> mat.hpp:812</div></div>
<div class="ttc" id="agroup__core__hal__interface_html_ga0610d99405b809062622588c25ed5c8f"><div class="ttname"><a href="../../d1/d1b/group__core__hal__interface.html#ga0610d99405b809062622588c25ed5c8f">CV_32FC3</a></div><div class="ttdeci">#define CV_32FC3</div><div class="ttdef"><b>Definition</b> interface.h:120</div></div>
</div><!-- fragment --> <div class="fragment"><div class="line">            <span class="keywordflow">if</span>(estimatePose) {</div>
<div class="line">                <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = 0u; i &lt; diamondIds.size(); i++)</div>
<div class="line">                    <a class="code hl_function" href="../../d9/d0c/group__calib3d.html#gab3ab7bb2bdfe7d5d9745bb92d13f9564">cv::drawFrameAxes</a>(imageCopy, camMatrix, distCoeffs, rvecs[i], tvecs[i], squareLength*1.1f);</div>
<div class="line">            }</div>
<div class="ttc" id="agroup__calib3d_html_gab3ab7bb2bdfe7d5d9745bb92d13f9564"><div class="ttname"><a href="../../d9/d0c/group__calib3d.html#gab3ab7bb2bdfe7d5d9745bb92d13f9564">cv::drawFrameAxes</a></div><div class="ttdeci">void drawFrameAxes(InputOutputArray image, InputArray cameraMatrix, InputArray distCoeffs, InputArray rvec, InputArray tvec, float length, int thickness=3)</div><div class="ttdoc">Draw axes of the world/object coordinate system from pose estimation.</div></div>
</div><!-- fragment --><p>The function will obtain the rotation and translation vector for each of the diamond marker and store them in <code>rvecs</code> and <code>tvecs</code>. Note that the diamond corners are a chessboard square corners and thus, the square length has to be provided for pose estimation, and not the marker length. Camera calibration parameters are also required.</p>
<p>Finally, an axis can be drawn to check the estimated pose is correct using <code>drawFrameAxes()</code>:</p>
<div class="image">
<img src="../../diamondsaxis.jpg" alt=""/>
<div class="caption">
Detected diamond axis</div></div>
    <p>The coordinate system of the diamond pose will be in the center of the marker with the Z axis pointing out, as in a simple ArUco marker pose estimation.</p>
<p>Sample video:</p>
<div align='center'><iframe title='Video' width='560' height='349' src='https://www.youtube.com/embed/OqKpBnglH7k?rel=0' frameborder='0' align='middle' allowfullscreen></iframe></div><p>Also ChArUco diamond pose can be estimated as ChArUco board: </p><div class="fragment"><div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0ull; i &lt; N; i++) { <span class="comment">// estimate diamond pose as Charuco board</span></div>
<div class="line">                    Mat objPoints_b, imgPoints;</div>
<div class="line">                    <span class="comment">// The coordinate system of the diamond is placed in the board plane centered in the bottom left corner</span></div>
<div class="line">                    vector&lt;int&gt; charucoIds = {0, 1, 3, 2}; <span class="comment">// if CCW order, Z axis pointing in the plane</span></div>
<div class="line">                    <span class="comment">// vector&lt;int&gt; charucoIds = {0, 2, 3, 1}; // if CW order, Z axis pointing out the plane</span></div>
<div class="line">                    charucoBoard.matchImagePoints(diamondCorners[i], charucoIds, objPoints_b, imgPoints);</div>
<div class="line">                    solvePnP(objPoints_b, imgPoints, camMatrix, distCoeffs, rvecs[i], tvecs[i]);</div>
<div class="line">                }</div>
</div><!-- fragment --><p>A full working example is included in the <code>detect_diamonds.cpp</code> inside the <code>samples/cpp/tutorial_code/objectDetection/</code>.</p>
<p>The samples <code>detect_diamonds.cpp</code> now take input via commandline via the <code><a class="el" href="../../d0/d2e/classcv_1_1CommandLineParser.html" title="Designed for command line parsing.">cv::CommandLineParser</a></code>. For this file the example parameters will look like: </p><div class="fragment"><div class="line">-dp=path_to_opencv/opencv/samples/cpp/tutorial_code/objectDetection/detector_params.yml -sl=0.4 -ml=0.25 -refine=3</div>
<div class="line">-v=path_to_opencv/opencv/doc/tutorials/objdetect/charuco_diamond_detection/images/diamondmarkers.jpg</div>
<div class="line">-cd=path_to_opencv/opencv/samples/cpp/tutorial_code/objectDetection/tutorial_dict.yml</div>
<div class="line">-c=path_to_opencv/opencv/samples/cpp/tutorial_code/objectDetection/tutorial_camera_params.yml</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.6-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Jun 2 2024 21:52:14 for OpenCV by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.9.8
</small></address>
<script type="text/javascript">
//<![CDATA[
addTutorialsButtons();
//]]>
</script>
</body>
</html>
