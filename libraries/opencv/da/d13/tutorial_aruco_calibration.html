<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<title>OpenCV: Calibration with ArUco and ChArUco</title>
<link href="../../opencv.ico" rel="shortcut icon" type="image/x-icon" />
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../tutorial-utils.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  },
  loader: {
    load: ['[tex]/ams']
  },
  tex: {
    macros: {},
    packages: ['base','configmacros','ams']
  }
};
//<![CDATA[
window.MathJax = {
    loader: {load: ['[tex]/ams']},
    tex: {
        packages: {'[+]': ['ams']},
        macros: {
            matTT: [ "\\[ \\left|\\begin{array}{ccc} #1 & #2 & #3\\\\ #4 & #5 & #6\\\\ #7 & #8 & #9 \\end{array}\\right| \\]", 9],
            fork: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ \\end{array} \\right.", 4],
            forkthree: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ #5 & \\mbox{#6}\\\\ \\end{array} \\right.", 6],
            forkfour: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ #5 & \\mbox{#6}\\\\ #7 & \\mbox{#8}\\\\ \\end{array} \\right.", 8],
            vecthree: ["\\begin{bmatrix} #1\\\\ #2\\\\ #3 \\end{bmatrix}", 3],
            vecthreethree: ["\\begin{bmatrix} #1 & #2 & #3\\\\ #4 & #5 & #6\\\\ #7 & #8 & #9 \\end{bmatrix}", 9],
            cameramatrix: ["#1 = \\begin{bmatrix} f_x & 0 & c_x\\\\ 0 & f_y & c_y\\\\ 0 & 0 & 1 \\end{bmatrix}", 1],
            distcoeffs: ["(k_1, k_2, p_1, p_2[, k_3[, k_4, k_5, k_6 [, s_1, s_2, s_3, s_4[, \\tau_x, \\tau_y]]]]) \\text{ of 4, 5, 8, 12 or 14 elements}"],
            distcoeffsfisheye: ["(k_1, k_2, k_3, k_4)"],
            hdotsfor: ["\\dots", 1],
            mathbbm: ["\\mathbb{#1}", 1],
            bordermatrix: ["\\matrix{#1}", 1]
        },
        processEscapes: false
    }
};
//]]>
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-chtml.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<!--#include virtual="/google-search.html"-->
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../opencv-logo-small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">OpenCV
   &#160;<span id="projectnumber">4.10.0</span>
   </div>
   <div id="projectbrief">Open Source Computer Vision</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../d9/df8/tutorial_root.html">OpenCV Tutorials</a></li><li class="navelem"><a class="el" href="../../d2/d64/tutorial_table_of_content_objdetect.html">Object Detection (objdetect module)</a></li>  </ul>
</div>
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Calibration with ArUco and ChArUco</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>Prev Tutorial:</b> <a class="el" href="../../d5/d07/tutorial_charuco_diamond_detection.html">Detection of Diamond Markers</a> <br  />
<b>Next Tutorial:</b> <a class="el" href="../../d1/dcb/tutorial_aruco_faq.html">Aruco module FAQ</a> <br  />
 The ArUco module can also be used to calibrate a camera. Camera calibration consists in obtaining the camera intrinsic parameters and distortion coefficients. This parameters remain fixed unless the camera optic is modified, thus camera calibration only need to be done once.</p>
<p>Camera calibration is usually performed using the OpenCV <code><a class="el" href="../../d9/d0c/group__calib3d.html#ga3207604e4b1a1758aa66acb6ed5aa65d" title="Finds the camera intrinsic and extrinsic parameters from several views of a calibration pattern.">cv::calibrateCamera()</a></code> function. This function requires some correspondences between environment points and their projection in the camera image from different viewpoints. In general, these correspondences are obtained from the corners of chessboard patterns. See <code><a class="el" href="../../d9/d0c/group__calib3d.html#ga3207604e4b1a1758aa66acb6ed5aa65d" title="Finds the camera intrinsic and extrinsic parameters from several views of a calibration pattern.">cv::calibrateCamera()</a></code> function documentation or the OpenCV calibration tutorial for more detailed information.</p>
<p>Using the ArUco module, calibration can be performed based on ArUco markers corners or ChArUco corners. Calibrating using ArUco is much more versatile than using traditional chessboard patterns, since it allows occlusions or partial views.</p>
<p>As it can be stated, calibration can be done using both, marker corners or ChArUco corners. However, it is highly recommended using the ChArUco corners approach since the provided corners are much more accurate in comparison to the marker corners. Calibration using a standard Board should only be employed in those scenarios where the ChArUco boards cannot be employed because of any kind of restriction.</p>
<h1><a class="anchor" id="autotoc_md1047"></a>
Calibration with ChArUco Boards</h1>
<p>To calibrate using a ChArUco board, it is necessary to detect the board from different viewpoints, in the same way that the standard calibration does with the traditional chessboard pattern. However, due to the benefits of using ChArUco, occlusions and partial views are allowed, and not all the corners need to be visible in all the viewpoints.</p>
<div class="image">
<img src="../../charucocalibration.jpg" alt=""/>
<div class="caption">
ChArUco calibration viewpoints</div></div>
    <p>The example of using <code><a class="el" href="../../d9/d0c/group__calib3d.html#ga3207604e4b1a1758aa66acb6ed5aa65d" title="Finds the camera intrinsic and extrinsic parameters from several views of a calibration pattern.">cv::calibrateCamera()</a></code> for <a class="el" href="../../d0/d3c/classcv_1_1aruco_1_1CharucoBoard.html" title="ChArUco board is a planar chessboard where the markers are placed inside the white squares of a chess...">cv::aruco::CharucoBoard</a>:</p>
<div class="fragment"><div class="line">    <span class="comment">// Create charuco board object and CharucoDetector</span></div>
<div class="line">    aruco::CharucoBoard board(Size(squaresX, squaresY), squareLength, markerLength, dictionary);</div>
<div class="line">    aruco::CharucoDetector detector(board, charucoParams, detectorParams);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Collect data from each frame</span></div>
<div class="line">    vector&lt;Mat&gt; allCharucoCorners, allCharucoIds;</div>
<div class="line"> </div>
<div class="line">    vector&lt;vector&lt;Point2f&gt;&gt; allImagePoints;</div>
<div class="line">    vector&lt;vector&lt;Point3f&gt;&gt; allObjectPoints;</div>
<div class="line"> </div>
<div class="line">    vector&lt;Mat&gt; allImages;</div>
<div class="line">    Size imageSize;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span>(inputVideo.grab()) {</div>
<div class="line">        Mat image, imageCopy;</div>
<div class="line">        inputVideo.retrieve(image);</div>
<div class="line"> </div>
<div class="line">        vector&lt;int&gt; markerIds;</div>
<div class="line">        vector&lt;vector&lt;Point2f&gt;&gt; markerCorners;</div>
<div class="line">        Mat currentCharucoCorners, currentCharucoIds;</div>
<div class="line">        vector&lt;Point3f&gt; currentObjectPoints;</div>
<div class="line">        vector&lt;Point2f&gt; currentImagePoints;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Detect ChArUco board</span></div>
<div class="line">        detector.detectBoard(image, currentCharucoCorners, currentCharucoIds);</div>
</div><!-- fragment --> <div class="fragment"><div class="line">        <span class="keywordflow">if</span>(key == <span class="charliteral">&#39;c&#39;</span> &amp;&amp; currentCharucoCorners.total() &gt; 3) {</div>
<div class="line">            <span class="comment">// Match image points</span></div>
<div class="line">            board.matchImagePoints(currentCharucoCorners, currentCharucoIds, currentObjectPoints, currentImagePoints);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span>(currentImagePoints.empty() || currentObjectPoints.empty()) {</div>
<div class="line">                cout &lt;&lt; <span class="stringliteral">&quot;Point matching failed, try again.&quot;</span> &lt;&lt; endl;</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            cout &lt;&lt; <span class="stringliteral">&quot;Frame captured&quot;</span> &lt;&lt; endl;</div>
<div class="line"> </div>
<div class="line">            allCharucoCorners.push_back(currentCharucoCorners);</div>
<div class="line">            allCharucoIds.push_back(currentCharucoIds);</div>
<div class="line">            allImagePoints.push_back(currentImagePoints);</div>
<div class="line">            allObjectPoints.push_back(currentObjectPoints);</div>
<div class="line">            allImages.push_back(image);</div>
<div class="line"> </div>
<div class="line">            imageSize = image.size();</div>
<div class="line">        }</div>
<div class="line">    }</div>
</div><!-- fragment --> <div class="fragment"><div class="line">    Mat cameraMatrix, distCoeffs;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>(calibrationFlags &amp; CALIB_FIX_ASPECT_RATIO) {</div>
<div class="line">        cameraMatrix = Mat::eye(3, 3, <a class="code hl_define" href="../../d1/d1b/group__core__hal__interface.html#ga30a562691cc5987bc88eb7bb7a8faf2b">CV_64F</a>);</div>
<div class="line">        cameraMatrix.at&lt;<span class="keywordtype">double</span>&gt;(0, 0) = aspectRatio;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Calibrate camera using ChArUco</span></div>
<div class="line">    <span class="keywordtype">double</span> repError = calibrateCamera(allObjectPoints, allImagePoints, imageSize, cameraMatrix, distCoeffs,</div>
<div class="line">                                      noArray(), noArray(), noArray(), noArray(), noArray(), calibrationFlags);</div>
<div class="ttc" id="agroup__core__hal__interface_html_ga30a562691cc5987bc88eb7bb7a8faf2b"><div class="ttname"><a href="../../d1/d1b/group__core__hal__interface.html#ga30a562691cc5987bc88eb7bb7a8faf2b">CV_64F</a></div><div class="ttdeci">#define CV_64F</div><div class="ttdef"><b>Definition</b> interface.h:79</div></div>
</div><!-- fragment --><p>The ChArUco corners and ChArUco identifiers captured on each viewpoint are stored in the vectors <code>allCharucoCorners</code> and <code>allCharucoIds</code>, one element per viewpoint.</p>
<p>The <code>calibrateCamera()</code> function will fill the <code>cameraMatrix</code> and <code>distCoeffs</code> arrays with the camera calibration parameters. It will return the reprojection error obtained from the calibration. The elements in <code>rvecs</code> and <code>tvecs</code> will be filled with the estimated pose of the camera (respect to the ChArUco board) in each of the viewpoints.</p>
<p>Finally, the <code>calibrationFlags</code> parameter determines some of the options for the calibration.</p>
<p>A full working example is included in the <code>calibrate_camera_charuco.cpp</code> inside the <code>samples/cpp/tutorial_code/objectDetection</code> folder.</p>
<p>The samples now take input via commandline via the <code><a class="el" href="../../d0/d2e/classcv_1_1CommandLineParser.html" title="Designed for command line parsing.">cv::CommandLineParser</a></code>. For this file the example parameters will look like: </p><div class="fragment"><div class="line"><span class="stringliteral">&quot;camera_calib.txt&quot;</span> -w=5 -h=7 -sl=0.04 -ml=0.02 -d=10</div>
<div class="line">-v=path/img_%02d.jpg</div>
</div><!-- fragment --><p>The camera calibration parameters from <code>opencv/samples/cpp/tutorial_code/objectDetection/tutorial_camera_charuco.yml</code> were obtained by the <code>img_00.jpg-img_03.jpg</code> placed from this <a href="https://github.com/opencv/opencv_contrib/tree/4.6.0/modules/aruco/tutorials/aruco_calibration/images" target="_blank">folder</a>.</p>
<h1><a class="anchor" id="autotoc_md1048"></a>
Calibration with ArUco Boards</h1>
<p>As it has been stated, it is recommended the use of ChAruco boards instead of ArUco boards for camera calibration, since ChArUco corners are more accurate than marker corners. However, in some special cases it must be required to use calibration based on ArUco boards. As in the previous case, it requires the detections of an ArUco board from different viewpoints.</p>
<div class="image">
<img src="../../arucocalibration.jpg" alt=""/>
<div class="caption">
ArUco calibration viewpoints</div></div>
    <p>The example of using <code><a class="el" href="../../d9/d0c/group__calib3d.html#ga3207604e4b1a1758aa66acb6ed5aa65d" title="Finds the camera intrinsic and extrinsic parameters from several views of a calibration pattern.">cv::calibrateCamera()</a></code> for <a class="el" href="../../de/d05/classcv_1_1aruco_1_1GridBoard.html" title="Planar board with grid arrangement of markers.">cv::aruco::GridBoard</a>:</p>
<div class="fragment"><div class="line">    <span class="comment">// Create board object and ArucoDetector</span></div>
<div class="line">    aruco::GridBoard gridboard(Size(markersX, markersY), markerLength, markerSeparation, dictionary);</div>
<div class="line">    aruco::ArucoDetector detector(dictionary, detectorParams);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Collected frames for calibration</span></div>
<div class="line">    vector&lt;vector&lt;vector&lt;Point2f&gt;&gt;&gt; allMarkerCorners;</div>
<div class="line">    vector&lt;vector&lt;int&gt;&gt; allMarkerIds;</div>
<div class="line">    Size imageSize;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span>(inputVideo.grab()) {</div>
<div class="line">        Mat image, imageCopy;</div>
<div class="line">        inputVideo.retrieve(image);</div>
<div class="line"> </div>
<div class="line">        vector&lt;int&gt; markerIds;</div>
<div class="line">        vector&lt;vector&lt;Point2f&gt;&gt; markerCorners, rejectedMarkers;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Detect markers</span></div>
<div class="line">        detector.detectMarkers(image, markerCorners, markerIds, rejectedMarkers);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Refind strategy to detect more markers</span></div>
<div class="line">        <span class="keywordflow">if</span>(refindStrategy) {</div>
<div class="line">            detector.refineDetectedMarkers(image, gridboard, markerCorners, markerIds, rejectedMarkers);</div>
<div class="line">        }</div>
</div><!-- fragment --> <div class="fragment"><div class="line">        <span class="keywordflow">if</span>(key == <span class="charliteral">&#39;c&#39;</span> &amp;&amp; !markerIds.empty()) {</div>
<div class="line">            cout &lt;&lt; <span class="stringliteral">&quot;Frame captured&quot;</span> &lt;&lt; endl;</div>
<div class="line">            allMarkerCorners.push_back(markerCorners);</div>
<div class="line">            allMarkerIds.push_back(markerIds);</div>
<div class="line">            imageSize = image.size();</div>
<div class="line">        }</div>
<div class="line">    }</div>
</div><!-- fragment --> <div class="fragment"><div class="line">    Mat cameraMatrix, distCoeffs;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>(calibrationFlags &amp; CALIB_FIX_ASPECT_RATIO) {</div>
<div class="line">        cameraMatrix = Mat::eye(3, 3, <a class="code hl_define" href="../../d1/d1b/group__core__hal__interface.html#ga30a562691cc5987bc88eb7bb7a8faf2b">CV_64F</a>);</div>
<div class="line">        cameraMatrix.at&lt;<span class="keywordtype">double</span>&gt;(0, 0) = aspectRatio;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Prepare data for calibration</span></div>
<div class="line">    vector&lt;Point3f&gt; objectPoints;</div>
<div class="line">    vector&lt;Point2f&gt; imagePoints;</div>
<div class="line">    vector&lt;Mat&gt; processedObjectPoints, processedImagePoints;</div>
<div class="line">    <span class="keywordtype">size_t</span> nFrames = allMarkerCorners.size();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> frame = 0; frame &lt; nFrames; frame++) {</div>
<div class="line">        Mat currentImgPoints, currentObjPoints;</div>
<div class="line"> </div>
<div class="line">        gridboard.matchImagePoints(allMarkerCorners[frame], allMarkerIds[frame], currentObjPoints, currentImgPoints);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span>(currentImgPoints.total() &gt; 0 &amp;&amp; currentObjPoints.total() &gt; 0) {</div>
<div class="line">            processedImagePoints.push_back(currentImgPoints);</div>
<div class="line">            processedObjectPoints.push_back(currentObjPoints);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Calibrate camera</span></div>
<div class="line">    <span class="keywordtype">double</span> repError = calibrateCamera(processedObjectPoints, processedImagePoints, imageSize, cameraMatrix, distCoeffs,</div>
<div class="line">                                      noArray(), noArray(), noArray(), noArray(), noArray(), calibrationFlags);</div>
</div><!-- fragment --><p>A full working example is included in the <code>calibrate_camera.cpp</code> inside the <code>samples/cpp/tutorial_code/objectDetection</code> folder.</p>
<p>The samples now take input via commandline via the <code><a class="el" href="../../d0/d2e/classcv_1_1CommandLineParser.html" title="Designed for command line parsing.">cv::CommandLineParser</a></code>. For this file the example parameters will look like: </p><div class="fragment"><div class="line"><span class="stringliteral">&quot;camera_calib.txt&quot;</span> -w=5 -h=7 -l=100 -s=10 -d=10 -v=path/aruco_videos_or_images</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.6-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Jun 2 2024 21:52:14 for OpenCV by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.9.8
</small></address>
<script type="text/javascript">
//<![CDATA[
addTutorialsButtons();
//]]>
</script>
</body>
</html>
